import sqlite3
from datetime import datetime

from flask import g


class SQLiteTaskRepository:
    def __init__(self, db_path):
        self.db_path = db_path

    def _get_db(self):
        if "db" not in g:
            g.db = sqlite3.connect(self.db_path)
            g.db.row_factory = sqlite3.Row
            g.db.execute("PRAGMA foreign_keys = ON")
        return g.db

    def close_db(self, exception=None):
        db = g.pop("db", None)
        if db is not None:
            db.close()

    def init_db(self):
        db = self._get_db()
        db.executescript(
            """
            CREATE TABLE IF NOT EXISTS projects (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL UNIQUE,
                created_at TEXT NOT NULL
            );

            CREATE TABLE IF NOT EXISTS labels (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL UNIQUE,
                color TEXT NOT NULL,
                created_at TEXT NOT NULL
            );

            CREATE TABLE IF NOT EXISTS project_labels (
                project_id INTEGER NOT NULL,
                label_id INTEGER NOT NULL,
                PRIMARY KEY (project_id, label_id),
                FOREIGN KEY (project_id) REFERENCES projects (id),
                FOREIGN KEY (label_id) REFERENCES labels (id)
            );

            CREATE TABLE IF NOT EXISTS tasks (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                created_at TEXT NOT NULL,
                project_id INTEGER
            );

            CREATE TABLE IF NOT EXISTS task_labels (
                task_id INTEGER NOT NULL,
                label_id INTEGER NOT NULL,
                PRIMARY KEY (task_id, label_id),
                FOREIGN KEY (task_id) REFERENCES tasks (id),
                FOREIGN KEY (label_id) REFERENCES labels (id)
            );

            CREATE TABLE IF NOT EXISTS time_entries (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                task_id INTEGER NOT NULL,
                started_at TEXT NOT NULL,
                ended_at TEXT,
                FOREIGN KEY (task_id) REFERENCES tasks (id)
            );

            CREATE TABLE IF NOT EXISTS goals (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                description TEXT,
                status TEXT NOT NULL,
                priority TEXT NOT NULL,
                target_date TEXT,
                target_seconds INTEGER NOT NULL DEFAULT 0,
                created_at TEXT NOT NULL
            );

            CREATE TABLE IF NOT EXISTS goal_projects (
                goal_id INTEGER NOT NULL,
                project_id INTEGER NOT NULL,
                PRIMARY KEY (goal_id, project_id),
                FOREIGN KEY (goal_id) REFERENCES goals (id) ON DELETE CASCADE,
                FOREIGN KEY (project_id) REFERENCES projects (id) ON DELETE CASCADE
            );

            CREATE TABLE IF NOT EXISTS goal_tasks (
                goal_id INTEGER NOT NULL,
                task_id INTEGER NOT NULL,
                PRIMARY KEY (goal_id, task_id),
                FOREIGN KEY (goal_id) REFERENCES goals (id) ON DELETE CASCADE,
                FOREIGN KEY (task_id) REFERENCES tasks (id) ON DELETE CASCADE
            );

            CREATE TABLE IF NOT EXISTS goal_subgoals (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                goal_id INTEGER NOT NULL,
                title TEXT NOT NULL,
                status TEXT NOT NULL DEFAULT 'pending',
                created_at TEXT NOT NULL,
                FOREIGN KEY (goal_id) REFERENCES goals (id) ON DELETE CASCADE
            );

            CREATE TABLE IF NOT EXISTS habits (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                frequency TEXT NOT NULL,
                time_of_day TEXT,
                reminder TEXT,
                notes TEXT,
                goal_name TEXT,
                subgoal_name TEXT,
                created_at TEXT NOT NULL
            );

            CREATE TABLE IF NOT EXISTS habit_logs (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                habit_id INTEGER NOT NULL,
                log_date TEXT NOT NULL,
                created_at TEXT NOT NULL,
                UNIQUE (habit_id, log_date),
                FOREIGN KEY (habit_id) REFERENCES habits (id) ON DELETE CASCADE
            );
            """
        )
        columns = db.execute("PRAGMA table_info(tasks)").fetchall()
        column_names = {column["name"] for column in columns}
        if "project_id" not in column_names:
            db.execute("ALTER TABLE tasks ADD COLUMN project_id INTEGER")
        habit_columns = db.execute("PRAGMA table_info(habits)").fetchall()
        habit_names = {column["name"] for column in habit_columns}
        if "goal_name" not in habit_names:
            db.execute("ALTER TABLE habits ADD COLUMN goal_name TEXT")
        if "subgoal_name" not in habit_names:
            db.execute("ALTER TABLE habits ADD COLUMN subgoal_name TEXT")
        db.commit()

    def ensure_default_project(self, name, created_at):
        db = self._get_db()
        db.execute(
            "INSERT OR IGNORE INTO projects (name, created_at) VALUES (?, ?)",
            (name, created_at),
        )
        row = db.execute(
            "SELECT id FROM projects WHERE name = ?",
            (name,),
        ).fetchone()
        return row["id"] if row else None

    def backfill_tasks_project(self, project_id):
        db = self._get_db()
        db.execute(
            "UPDATE tasks SET project_id = ? WHERE project_id IS NULL OR project_id = 0",
            (project_id,),
        )
        db.commit()
        db.commit()

    def fetch_tasks(self):
        db = self._get_db()
        tasks = db.execute(
            """
            WITH params AS (
                SELECT
                    CAST(strftime('%s','now') AS INTEGER) AS now_ts,
                    CAST(strftime('%s','now','-24 hours') AS INTEGER) AS window_start
            )
            SELECT t.id, t.name, t.project_id, p.name AS project_name,
                   IFNULL(SUM(
                       CASE
                           WHEN te.id IS NULL THEN 0
                           WHEN te.ended_at IS NULL THEN (strftime('%s','now') - strftime('%s', te.started_at))
                           ELSE (strftime('%s', te.ended_at) - strftime('%s', te.started_at))
                       END
                   ), 0) AS total_seconds,
                   IFNULL(SUM(
                       CASE
                           WHEN te.id IS NULL THEN 0
                           ELSE MAX(
                               0,
                               MIN(
                                   COALESCE(CAST(strftime('%s', te.ended_at) AS INTEGER), params.now_ts),
                                   params.now_ts
                               ) - MAX(CAST(strftime('%s', te.started_at) AS INTEGER), params.window_start)
                           )
                       END
                   ), 0) AS rolling_24h_seconds,
                   MAX(CASE WHEN te.id IS NOT NULL AND te.ended_at IS NULL THEN 1 ELSE 0 END) AS is_running
            FROM tasks t
            CROSS JOIN params
            LEFT JOIN projects p ON p.id = t.project_id
            LEFT JOIN time_entries te ON te.task_id = t.id
            GROUP BY t.id
            ORDER BY t.created_at DESC
            """
        ).fetchall()
        return tasks

    def fetch_tasks_by_project(self, project_id):
        db = self._get_db()
        tasks = db.execute(
            """
            WITH params AS (
                SELECT
                    CAST(strftime('%s','now') AS INTEGER) AS now_ts,
                    CAST(strftime('%s','now','-24 hours') AS INTEGER) AS window_start
            )
            SELECT t.id, t.name, t.project_id, p.name AS project_name,
                   IFNULL(SUM(
                       CASE
                           WHEN te.id IS NULL THEN 0
                           WHEN te.ended_at IS NULL THEN (strftime('%s','now') - strftime('%s', te.started_at))
                           ELSE (strftime('%s', te.ended_at) - strftime('%s', te.started_at))
                       END
                   ), 0) AS total_seconds,
                   IFNULL(SUM(
                       CASE
                           WHEN te.id IS NULL THEN 0
                           ELSE MAX(
                               0,
                               MIN(
                                   COALESCE(CAST(strftime('%s', te.ended_at) AS INTEGER), params.now_ts),
                                   params.now_ts
                               ) - MAX(CAST(strftime('%s', te.started_at) AS INTEGER), params.window_start)
                           )
                       END
                   ), 0) AS rolling_24h_seconds,
                   MAX(CASE WHEN te.id IS NOT NULL AND te.ended_at IS NULL THEN 1 ELSE 0 END) AS is_running
            FROM tasks t
            CROSS JOIN params
            LEFT JOIN projects p ON p.id = t.project_id
            LEFT JOIN time_entries te ON te.task_id = t.id
            WHERE t.project_id = ?
            GROUP BY t.id
            ORDER BY t.created_at DESC
            """,
            (project_id,),
        ).fetchall()
        return tasks

    def fetch_project(self, project_id):
        db = self._get_db()
        return db.execute(
            "SELECT id, name, created_at FROM projects WHERE id = ?",
            (project_id,),
        ).fetchone()

    def create_task(self, name, created_at, project_id):
        db = self._get_db()
        db.execute(
            "INSERT INTO tasks (name, created_at, project_id) VALUES (?, ?, ?)",
            (name, created_at, project_id),
        )
        db.commit()
        return db.execute("SELECT last_insert_rowid()").fetchone()[0]

    def update_task(self, task_id, name):
        db = self._get_db()
        db.execute(
            "UPDATE tasks SET name = ? WHERE id = ?",
            (name, task_id),
        )
        db.commit()

    def fetch_projects(self):
        db = self._get_db()
        return db.execute(
            "SELECT id, name, created_at FROM projects ORDER BY created_at DESC"
        ).fetchall()

    def fetch_projects_by_ids(self, project_ids):
        if not project_ids:
            return []
        db = self._get_db()
        placeholders = ",".join(["?"] * len(project_ids))
        return db.execute(
            f"SELECT id, name, created_at FROM projects WHERE id IN ({placeholders})",
            tuple(project_ids),
        ).fetchall()

    def create_project(self, name, created_at):
        db = self._get_db()
        db.execute(
            "INSERT INTO projects (name, created_at) VALUES (?, ?)",
            (name, created_at),
        )
        db.commit()
        return db.execute("SELECT last_insert_rowid()").fetchone()[0]

    def update_project(self, project_id, name):
        db = self._get_db()
        db.execute(
            "UPDATE projects SET name = ? WHERE id = ?",
            (name, project_id),
        )
        db.commit()

    def delete_project(self, project_id):
        db = self._get_db()
        db.execute(
            """
            DELETE FROM time_entries
            WHERE task_id IN (SELECT id FROM tasks WHERE project_id = ?)
            """,
            (project_id,),
        )
        db.execute(
            "DELETE FROM task_labels WHERE task_id IN (SELECT id FROM tasks WHERE project_id = ?)",
            (project_id,),
        )
        db.execute("DELETE FROM project_labels WHERE project_id = ?", (project_id,))
        db.execute("DELETE FROM tasks WHERE project_id = ?", (project_id,))
        db.execute("DELETE FROM projects WHERE id = ?", (project_id,))
        db.commit()

    def fetch_labels(self):
        db = self._get_db()
        return db.execute(
            "SELECT id, name, color, created_at FROM labels ORDER BY created_at DESC"
        ).fetchall()

    def fetch_tasks_by_project_ids(self, project_ids):
        if not project_ids:
            return []
        db = self._get_db()
        placeholders = ",".join(["?"] * len(project_ids))
        return db.execute(
            f"""
            SELECT id, name, created_at, project_id
            FROM tasks
            WHERE project_id IN ({placeholders})
            """,
            tuple(project_ids),
        ).fetchall()

    def fetch_task_total_seconds(self, task_ids):
        if not task_ids:
            return {}
        db = self._get_db()
        placeholders = ",".join(["?"] * len(task_ids))
        rows = db.execute(
            f"""
            SELECT t.id AS task_id,
                   IFNULL(SUM(
                       CASE
                           WHEN te.id IS NULL THEN 0
                           WHEN te.ended_at IS NULL THEN (strftime('%s','now') - strftime('%s', te.started_at))
                           ELSE (strftime('%s', te.ended_at) - strftime('%s', te.started_at))
                       END
                   ), 0) AS total_seconds
            FROM tasks t
            LEFT JOIN time_entries te ON te.task_id = t.id
            WHERE t.id IN ({placeholders})
            GROUP BY t.id
            """,
            tuple(task_ids),
        ).fetchall()
        return {row["task_id"]: int(row["total_seconds"] or 0) for row in rows}

    def create_label(self, name, color, created_at):
        db = self._get_db()
        db.execute(
            "INSERT INTO labels (name, color, created_at) VALUES (?, ?, ?)",
            (name, color, created_at),
        )
        db.commit()

    def update_label(self, label_id, name, color):
        db = self._get_db()
        db.execute(
            "UPDATE labels SET name = ?, color = ? WHERE id = ?",
            (name, color, label_id),
        )
        db.commit()

    def delete_label(self, label_id):
        db = self._get_db()
        db.execute("DELETE FROM task_labels WHERE label_id = ?", (label_id,))
        db.execute("DELETE FROM project_labels WHERE label_id = ?", (label_id,))
        db.execute("DELETE FROM labels WHERE id = ?", (label_id,))
        db.commit()

    def add_label_to_task(self, task_id, label_id):
        db = self._get_db()
        db.execute(
            "INSERT OR IGNORE INTO task_labels (task_id, label_id) VALUES (?, ?)",
            (task_id, label_id),
        )
        db.commit()

    def add_label_to_project(self, project_id, label_id):
        db = self._get_db()
        db.execute(
            "INSERT OR IGNORE INTO project_labels (project_id, label_id) VALUES (?, ?)",
            (project_id, label_id),
        )
        db.commit()

    def fetch_goals(self):
        db = self._get_db()
        return db.execute(
            """
            SELECT id, name, description, status, priority, target_date, target_seconds, created_at
            FROM goals
            ORDER BY created_at DESC
            """
        ).fetchall()

    def fetch_goal(self, goal_id):
        db = self._get_db()
        return db.execute(
            """
            SELECT id, name, description, status, priority, target_date, target_seconds, created_at
            FROM goals
            WHERE id = ?
            """,
            (goal_id,),
        ).fetchone()

    def create_goal(self, name, description, status, priority, target_date, target_seconds, created_at):
        db = self._get_db()
        db.execute(
            """
            INSERT INTO goals (name, description, status, priority, target_date, target_seconds, created_at)
            VALUES (?, ?, ?, ?, ?, ?, ?)
            """,
            (name, description, status, priority, target_date, target_seconds, created_at),
        )
        db.commit()
        return db.execute("SELECT last_insert_rowid()").fetchone()[0]

    def update_goal(self, goal_id, name, description, status, priority, target_date, target_seconds):
        db = self._get_db()
        db.execute(
            """
            UPDATE goals
            SET name = ?, description = ?, status = ?, priority = ?, target_date = ?, target_seconds = ?
            WHERE id = ?
            """,
            (name, description, status, priority, target_date, target_seconds, goal_id),
        )
        db.commit()

    def delete_goal(self, goal_id):
        db = self._get_db()
        db.execute("DELETE FROM goal_tasks WHERE goal_id = ?", (goal_id,))
        db.execute("DELETE FROM goal_projects WHERE goal_id = ?", (goal_id,))
        db.execute("DELETE FROM goal_subgoals WHERE goal_id = ?", (goal_id,))
        db.execute("DELETE FROM goals WHERE id = ?", (goal_id,))
        db.commit()

    def fetch_goal_projects(self, goal_ids):
        if not goal_ids:
            return {}
        db = self._get_db()
        placeholders = ",".join(["?"] * len(goal_ids))
        rows = db.execute(
            f"""
            SELECT goal_id, project_id
            FROM goal_projects
            WHERE goal_id IN ({placeholders})
            """,
            tuple(goal_ids),
        ).fetchall()
        mapping = {}
        for row in rows:
            mapping.setdefault(row["goal_id"], []).append(row["project_id"])
        return mapping

    def fetch_goal_tasks(self, goal_ids):
        if not goal_ids:
            return {}
        db = self._get_db()
        placeholders = ",".join(["?"] * len(goal_ids))
        rows = db.execute(
            f"""
            SELECT goal_id, task_id
            FROM goal_tasks
            WHERE goal_id IN ({placeholders})
            """,
            tuple(goal_ids),
        ).fetchall()
        mapping = {}
        for row in rows:
            mapping.setdefault(row["goal_id"], []).append(row["task_id"])
        return mapping

    def fetch_goal_subgoals(self, goal_ids):
        if not goal_ids:
            return {}
        db = self._get_db()
        placeholders = ",".join(["?"] * len(goal_ids))
        rows = db.execute(
            f"""
            SELECT id, goal_id, title, status, created_at
            FROM goal_subgoals
            WHERE goal_id IN ({placeholders})
            ORDER BY created_at ASC
            """,
            tuple(goal_ids),
        ).fetchall()
        mapping = {}
        for row in rows:
            mapping.setdefault(row["goal_id"], []).append(
                {
                    "id": row["id"],
                    "title": row["title"],
                    "status": row["status"],
                    "created_at": row["created_at"],
                }
            )
        return mapping

    def set_goal_projects(self, goal_id, project_ids):
        db = self._get_db()
        db.execute("DELETE FROM goal_projects WHERE goal_id = ?", (goal_id,))
        for project_id in project_ids:
            db.execute(
                "INSERT OR IGNORE INTO goal_projects (goal_id, project_id) VALUES (?, ?)",
                (goal_id, project_id),
            )
        db.commit()

    def set_goal_tasks(self, goal_id, task_ids):
        db = self._get_db()
        db.execute("DELETE FROM goal_tasks WHERE goal_id = ?", (goal_id,))
        for task_id in task_ids:
            db.execute(
                "INSERT OR IGNORE INTO goal_tasks (goal_id, task_id) VALUES (?, ?)",
                (goal_id, task_id),
            )
        db.commit()

    def set_goal_subgoals(self, goal_id, subgoal_titles, created_at):
        db = self._get_db()
        db.execute("DELETE FROM goal_subgoals WHERE goal_id = ?", (goal_id,))
        for title in subgoal_titles:
            db.execute(
                """
                INSERT INTO goal_subgoals (goal_id, title, status, created_at)
                VALUES (?, ?, ?, ?)
                """,
                (goal_id, title, "pending", created_at),
            )
        db.commit()

    def fetch_habits(self):
        db = self._get_db()
        return db.execute(
            """
            SELECT id, name, frequency, time_of_day, reminder, notes, goal_name, subgoal_name, created_at
            FROM habits
            ORDER BY created_at DESC
            """
        ).fetchall()

    def create_habit(
        self,
        name,
        frequency,
        time_of_day,
        reminder,
        notes,
        goal_name,
        subgoal_name,
        created_at,
    ):
        db = self._get_db()
        db.execute(
            """
            INSERT INTO habits (name, frequency, time_of_day, reminder, notes, goal_name, subgoal_name, created_at)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            """,
            (name, frequency, time_of_day, reminder, notes, goal_name, subgoal_name, created_at),
        )
        db.commit()
        return db.execute("SELECT last_insert_rowid()").fetchone()[0]

    def update_habit(
        self,
        habit_id,
        name,
        frequency,
        time_of_day,
        reminder,
        notes,
        goal_name,
        subgoal_name,
    ):
        db = self._get_db()
        db.execute(
            """
            UPDATE habits
            SET name = ?, frequency = ?, time_of_day = ?, reminder = ?, notes = ?, goal_name = ?, subgoal_name = ?
            WHERE id = ?
            """,
            (name, frequency, time_of_day, reminder, notes, goal_name, subgoal_name, habit_id),
        )
        db.commit()

    def delete_habit(self, habit_id):
        db = self._get_db()
        db.execute("DELETE FROM habit_logs WHERE habit_id = ?", (habit_id,))
        db.execute("DELETE FROM habits WHERE id = ?", (habit_id,))
        db.commit()

    def fetch_habit_logs_for_date(self, habit_ids, log_date):
        if not habit_ids:
            return set()
        db = self._get_db()
        placeholders = ",".join(["?"] * len(habit_ids))
        rows = db.execute(
            f"""
            SELECT habit_id
            FROM habit_logs
            WHERE habit_id IN ({placeholders}) AND log_date = ?
            """,
            tuple(habit_ids) + (log_date,),
        ).fetchall()
        return {row["habit_id"] for row in rows}

    def fetch_habit_logs_map(self, habit_ids):
        if not habit_ids:
            return {}
        db = self._get_db()
        placeholders = ",".join(["?"] * len(habit_ids))
        rows = db.execute(
            f"""
            SELECT habit_id, log_date
            FROM habit_logs
            WHERE habit_id IN ({placeholders})
            ORDER BY log_date DESC
            """,
            tuple(habit_ids),
        ).fetchall()
        mapping = {}
        for row in rows:
            mapping.setdefault(row["habit_id"], set()).add(row["log_date"])
        return mapping

    def set_habit_log(self, habit_id, log_date, done):
        db = self._get_db()
        if done:
            db.execute(
                """
                INSERT OR IGNORE INTO habit_logs (habit_id, log_date, created_at)
                VALUES (?, ?, ?)
                """,
                (habit_id, log_date, datetime.utcnow().isoformat()),
            )
        else:
            db.execute(
                "DELETE FROM habit_logs WHERE habit_id = ? AND log_date = ?",
                (habit_id, log_date),
            )
        db.commit()

    def fetch_task_labels_map(self, task_ids):
        if not task_ids:
            return {}
        db = self._get_db()
        placeholders = ",".join(["?"] * len(task_ids))
        rows = db.execute(
            f"""
            SELECT tl.task_id, l.id, l.name, l.color
            FROM task_labels tl
            JOIN labels l ON l.id = tl.label_id
            WHERE tl.task_id IN ({placeholders})
            ORDER BY l.created_at DESC
            """,
            tuple(task_ids),
        ).fetchall()
        labels_map = {}
        for row in rows:
            labels_map.setdefault(row["task_id"], []).append(
                {"id": row["id"], "name": row["name"], "color": row["color"]}
            )
        return labels_map

    def fetch_project_labels_map(self, project_ids):
        if not project_ids:
            return {}
        db = self._get_db()
        placeholders = ",".join(["?"] * len(project_ids))
        rows = db.execute(
            f"""
            SELECT pl.project_id, l.id, l.name, l.color
            FROM project_labels pl
            JOIN labels l ON l.id = pl.label_id
            WHERE pl.project_id IN ({placeholders})
            ORDER BY l.created_at DESC
            """,
            tuple(project_ids),
        ).fetchall()
        labels_map = {}
        for row in rows:
            labels_map.setdefault(row["project_id"], []).append(
                {"id": row["id"], "name": row["name"], "color": row["color"]}
            )
        return labels_map

    def is_task_running(self, task_id):
        db = self._get_db()
        row = db.execute(
            "SELECT 1 FROM time_entries WHERE task_id = ? AND ended_at IS NULL",
            (task_id,),
        ).fetchone()
        return row is not None

    def start_task(self, task_id, started_at):
        db = self._get_db()
        db.execute(
            "INSERT INTO time_entries (task_id, started_at) VALUES (?, ?)",
            (task_id, started_at),
        )
        db.commit()

    def stop_task(self, task_id, ended_at):
        db = self._get_db()
        db.execute(
            """
            UPDATE time_entries
            SET ended_at = ?
            WHERE task_id = ? AND ended_at IS NULL
            """,
            (ended_at, task_id),
        )
        db.commit()

    def delete_task(self, task_id):
        db = self._get_db()
        db.execute("DELETE FROM time_entries WHERE task_id = ?", (task_id,))
        db.execute("DELETE FROM tasks WHERE id = ?", (task_id,))
        db.commit()

    def fetch_time_entries_between(self, start_iso, end_iso):
        db = self._get_db()
        return db.execute(
            """
            SELECT id, task_id, started_at, ended_at
            FROM time_entries
            WHERE started_at < ?
              AND (ended_at IS NULL OR ended_at > ?)
            """,
            (end_iso, start_iso),
        ).fetchall()

    def fetch_time_entries_with_projects_between(self, start_iso, end_iso):
        db = self._get_db()
        return db.execute(
            """
            SELECT te.id, te.task_id, te.started_at, te.ended_at,
                   t.project_id, p.name AS project_name
            FROM time_entries te
            JOIN tasks t ON t.id = te.task_id
            LEFT JOIN projects p ON p.id = t.project_id
            WHERE te.started_at < ?
              AND (te.ended_at IS NULL OR te.ended_at > ?)
            """,
            (end_iso, start_iso),
        ).fetchall()

    def fetch_time_entries_with_tasks_between(self, start_iso, end_iso):
        db = self._get_db()
        return db.execute(
            """
            SELECT te.id, te.task_id, te.started_at, te.ended_at,
                   t.name AS task_name
            FROM time_entries te
            JOIN tasks t ON t.id = te.task_id
            WHERE te.started_at < ?
              AND (te.ended_at IS NULL OR te.ended_at > ?)
            """,
            (end_iso, start_iso),
        ).fetchall()

    def fetch_time_entries_with_labels_between(self, start_iso, end_iso):
        db = self._get_db()
        return db.execute(
            """
            SELECT te.id, te.task_id, te.started_at, te.ended_at,
                   l.name AS label_name
            FROM time_entries te
            JOIN task_labels tl ON tl.task_id = te.task_id
            JOIN labels l ON l.id = tl.label_id
            WHERE te.started_at < ?
              AND (te.ended_at IS NULL OR te.ended_at > ?)
            """,
            (end_iso, start_iso),
        ).fetchall()

    def fetch_time_entries_with_task_details_between(self, start_iso, end_iso):
        db = self._get_db()
        return db.execute(
            """
            SELECT te.id, te.task_id, te.started_at, te.ended_at,
                   t.name AS task_name, p.name AS project_name
            FROM time_entries te
            JOIN tasks t ON t.id = te.task_id
            LEFT JOIN projects p ON p.id = t.project_id
            WHERE te.started_at < ?
              AND (te.ended_at IS NULL OR te.ended_at > ?)
            ORDER BY te.started_at DESC
            """,
            (end_iso, start_iso),
        ).fetchall()
