{% extends "layout.html" %}
{% set title = "Timer" %}
{% set active_page = "timer" %}

{% block head_extra %}
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fullcalendar/fullcalendar.min.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/litepicker/litepicker.css') }}" />
{% endblock %}

{% block content %}
  <div class="timer-page">
    <header class="timer-hero">
      <div class="timer-controls">
        <div class="timer-select">
          <label class="timer-input-label" for="task-picker">Current task</label>
          <div class="timer-input-group">
            <input
              id="task-picker"
              type="text"
              placeholder="What are you working on?"
              autocomplete="off"
              aria-expanded="false"
              aria-controls="task-dropdown"
            />
            <button class="timer-clear" id="task-clear" type="button" aria-label="Clear selected task" disabled>
              <i class="bi bi-x"></i>
            </button>
          </div>
          <div class="timer-dropdown" id="task-dropdown">
            <input class="timer-search" type="text" placeholder="Search tasks..." />
            <div class="timer-list">
              <button type="button">Recent: Design VPC Architecture</button>
              <button type="button">Recent: Build ETL Jobs</button>
              <button type="button">Recent: Refactor Navigation</button>
              <button type="button">Inventory Legacy Services</button>
              <button type="button">Accessibility QA</button>
            </div>
          </div>
        </div>
        <div class="timer-actions">
          <button class="btn btn-primary btn-sm timer-btn primary" type="button" aria-label="Start or Pause" data-timer-toggle>
            <span class="timer-btn-icon timer-btn-icon--start">
              <i class="bi bi-play-fill"></i>
            </span>
            <span class="timer-btn-icon timer-btn-icon--pause">
              <i class="bi bi-pause-fill"></i>
            </span>
            <span class="timer-btn-label">Start</span>
          </button>
          <button class="btn btn-outline-secondary btn-sm timer-btn ghost" type="button" data-timer-reset>
            Reset
          </button>
          <button class="btn btn-outline-secondary btn-sm timer-btn ghost" type="button" data-timer-skip>
            Skip
          </button>
        </div>
      </div>
      <div class="timer-hero-meta">
        <div class="timer-chip" id="pomodoro-chip-mode">Focus</div>
        <div class="timer-chip timer-chip--accent" id="pomodoro-chip-remaining">25:00</div>
        <div class="timer-chip" id="pomodoro-chip-session">Session 1/4</div>
      </div>
    </header>
    <section class="timer-range-section">
      <div class="timer-range-card">
        <div class="timer-range-left">
          <div class="calendar-row">
            <input class="calendar-input" id="timer-range" type="text" readonly />
          </div>
        </div>
        <div class="timer-range-summary">
          <div class="timer-summary-item">
            <span class="timer-summary-label">TODAY</span>
            <span class="timer-summary-value">02:15:00</span>
          </div>
          <div class="timer-summary-item">
            <span class="timer-summary-label">WEEK TOTAL</span>
            <span class="timer-summary-value">18:40:00</span>
          </div>
        </div>
        <div class="timer-range-right">
          <div class="timer-view-box">
            <button class="btn btn-outline-primary btn-sm timer-view-btn is-active" type="button" data-view-button="calendar">
              <i class="bi bi-calendar-week"></i>
              Calendar
            </button>
            <button class="btn btn-outline-primary btn-sm timer-view-btn" type="button" data-view-button="list">
              <i class="bi bi-list-check"></i>
              View List
            </button>
            <button class="btn btn-outline-primary btn-sm timer-view-btn" type="button" data-view-button="timesheet">
              <i class="bi bi-clock-history"></i>
              Timesheet
            </button>
          </div>
        </div>
      </div>
    </section>
    <section class="timer-range-section">
      <div class="card pomodoro-card">
        <div class="pomodoro-header">
          <div class="pomodoro-copy">
            <p class="pomodoro-label">Pomodoro</p>
            <h2 class="pomodoro-mode" id="pomodoro-mode">Focus</h2>
            <div class="pomodoro-status">
              <p class="pomodoro-task" id="pomodoro-task">No task selected</p>
              <p class="pomodoro-meta" id="pomodoro-meta" aria-live="polite">Session 1 of 4</p>
            </div>
            <div class="pomodoro-dots" aria-hidden="true">
              <span data-session-dot="1"></span>
              <span data-session-dot="2"></span>
              <span data-session-dot="3"></span>
              <span data-session-dot="4"></span>
            </div>
          </div>
          <div class="pomodoro-clock">
            <div class="pomodoro-ring">
              <div class="pomodoro-dial" id="pomodoro-display" role="timer" aria-live="polite">25:00</div>
              <span class="pomodoro-caption">Remaining</span>
            </div>
          </div>
        </div>
        <div class="pomodoro-controls">
          <button class="btn btn-primary btn-sm" type="button" id="pomodoro-start">
            <i class="bi bi-play-fill"></i>
            Start
          </button>
          <button class="btn btn-outline-primary btn-sm" type="button" id="pomodoro-pause">
            <i class="bi bi-pause-fill"></i>
            Pause
          </button>
          <button class="btn btn-outline-secondary btn-sm" type="button" id="pomodoro-reset">
            <i class="bi bi-arrow-counterclockwise"></i>
            Reset
          </button>
          <button class="btn btn-outline-secondary btn-sm" type="button" id="pomodoro-skip">
            <i class="bi bi-skip-forward-fill"></i>
            Skip
          </button>
        </div>
        <div class="pomodoro-presets">
          <button class="btn btn-light btn-sm" type="button" data-pomodoro-mode="work">Focus 25</button>
          <button class="btn btn-light btn-sm" type="button" data-pomodoro-mode="short">Break 5</button>
          <button class="btn btn-light btn-sm" type="button" data-pomodoro-mode="long">Break 15</button>
        </div>
      </div>
    </section>
    <section class="timer-calendar-section timer-view-panel is-active" data-view-panel="calendar">
      <div class="card timer-calendar-card">
        <div id="timer-calendar"></div>
      </div>
    </section>
    <section class="timer-calendar-section timer-view-panel" data-view-panel="list">
      <div class="card timer-list-card">
        {% if timer_list_groups %}
          {% for group in timer_list_groups %}
            <div class="timer-list-group">
              <div class="timer-list-header">
                <span class="timer-list-day">{{ group["label"] }}</span>
                <span class="timer-list-total">{{ group["total_seconds"] | format_seconds }}</span>
              </div>
              {% for entry in group["entries"] %}
                <div class="timer-list-item" data-task-id="{{ entry['task_id'] }}">
                  <div class="timer-list-row">
                    <div class="timer-list-left">
                      {% if entry["labels"] %}
                        <span class="timer-list-label">{{ entry["labels"] | join(", ") }}</span>
                      {% endif %}
                    </div>
                    <div class="timer-list-center">
                      <span class="timer-list-title">{{ entry["task_name"] }}</span>
                      <span class="timer-list-project">{{ entry["project_name"] }}</span>
                    </div>
                    <div class="timer-list-right">
                      <span class="timer-list-time">{{ entry["start_time"] }} - {{ entry["end_time"] }}</span>
                      <span class="timer-list-duration">{{ entry["duration_seconds"] | format_seconds }}</span>
                        <div class="timer-list-actions">
                          {% if entry["is_running"] %}
                            <form method="post" action="{{ url_for('stop_task', task_id=entry['task_id']) }}" data-action="stop" data-task-id="{{ entry['task_id'] }}" data-task-name="{{ entry['task_name'] }}">
                              <button class="btn btn-outline-warning btn-sm timer-list-action pause" type="submit" aria-label="Pause task timer">
                                <i class="bi bi-pause-fill"></i>
                              </button>
                            </form>
                          {% else %}
                            <form method="post" action="{{ url_for('start_task', task_id=entry['task_id']) }}" data-action="start" data-task-id="{{ entry['task_id'] }}" data-task-name="{{ entry['task_name'] }}">
                              <button class="btn btn-outline-primary btn-sm timer-list-action resume" type="submit" aria-label="Start task timer">
                                <i class="bi bi-play-fill"></i>
                              </button>
                            </form>
                          {% endif %}
                        </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% endfor %}
        {% else %}
          <div class="timer-empty-state">No entries yet.</div>
        {% endif %}
      </div>
    </section>
    <section class="timer-calendar-section timer-view-panel" data-view-panel="timesheet">
      <div class="card timer-list-card">
        <div class="timer-empty-state">No timesheet data yet.</div>
      </div>
    </section>
  </div>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='vendor/fullcalendar/fullcalendar.min.js') }}"></script>
  <script src="{{ url_for('static', filename='vendor/litepicker/litepicker.js') }}"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const rangeInput = document.getElementById("timer-range");
      if (rangeInput && typeof Litepicker !== "undefined") {
        const today = new Date();
        const startValue = "{{ timer_range_start or '' }}";
        const endValue = "{{ timer_range_end or '' }}";
        const start = startValue ? new Date(`${startValue}T00:00:00`) : new Date(today);
        const end = endValue ? new Date(`${endValue}T00:00:00`) : new Date(today);
        if (!startValue) {
          start.setDate(today.getDate() - 6);
        }
        const picker = new Litepicker({
          element: rangeInput,
          singleMode: false,
          startDate: start,
          endDate: end,
          showTooltip: false,
          numberOfMonths: 1,
          numberOfColumns: 1,
          format: "YYYY-MM-DD",
        });
        rangeInput.value = `${picker.getStartDate().format("YYYY-MM-DD")} → ${picker
          .getEndDate()
          .format("YYYY-MM-DD")}`;
        picker.on("selected", (date1, date2) => {
          if (!date1 || !date2) {
            return;
          }
          const nextStart = date1.format("YYYY-MM-DD");
          const nextEnd = date2.format("YYYY-MM-DD");
          window.location.search = `?start=${nextStart}&end=${nextEnd}`;
        });
      }

      const panels = document.querySelectorAll("[data-view-panel]");
      const buttons = document.querySelectorAll("[data-view-button]");
      const calendarEl = document.getElementById("timer-calendar");
      const taskPicker = document.getElementById("task-picker");
      const taskDropdown = document.querySelector(".timer-dropdown");
      const taskSearch = document.querySelector(".timer-search");
      const taskList = document.querySelector(".timer-list");
      let cachedTasks = [];
      const calendar =
        calendarEl && typeof FullCalendar !== "undefined"
          ? new FullCalendar.Calendar(calendarEl, {
              initialView: "dayGridMonth",
              height: "auto",
              headerToolbar: {
                left: "prev,next",
                center: "title",
                right: "",
              },
              navLinks: true,
              dayMaxEvents: 4,
              dayMaxEventRows: 4,
              eventDisplay: "block",
              dateClick: (info) => {
                calendar.changeView("dayGridDay", info.dateStr);
              },
              eventClick: (info) => {
                const taskId = info.event.extendedProps?.taskId;
                const listButton = document.querySelector('[data-view-button="list"]');
                if (listButton) {
                  listButton.click();
                }
                if (!taskId) {
                  return;
                }
                const target = document.querySelector(`[data-task-id="${taskId}"]`);
                if (target) {
                  target.classList.add("is-highlight");
                  target.scrollIntoView({ behavior: "smooth", block: "center" });
                  setTimeout(() => target.classList.remove("is-highlight"), 2000);
                }
                info.jsEvent.preventDefault();
              },
              events: (info, success, failure) => {
                const params = new URLSearchParams({
                  start: info.startStr,
                  end: info.endStr,
                });
                fetch(`/api/timer/entries?${params.toString()}`)
                  .then((response) => response.json())
                  .then((payload) => success(payload.events || []))
                  .catch((error) => {
                    console.error(error);
                    failure(error);
                  });
              },
            })
          : null;
      if (calendar) {
        calendar.render();
      }

      buttons.forEach((button) => {
        button.addEventListener("click", () => {
          const targetView = button.dataset.viewButton;
          buttons.forEach((btn) => btn.classList.toggle("is-active", btn === button));
          panels.forEach((panel) =>
            panel.classList.toggle("is-active", panel.dataset.viewPanel === targetView),
          );
          if (targetView === "calendar" && calendar) {
            calendar.updateSize();
          }
        });
      });

      const pomodoroDisplay = document.getElementById("pomodoro-display");
      const pomodoroMode = document.getElementById("pomodoro-mode");
      const pomodoroTask = document.getElementById("pomodoro-task");
      const pomodoroMeta = document.getElementById("pomodoro-meta");
      const pomodoroRing = document.querySelector(".pomodoro-ring");
      const pomodoroDots = document.querySelectorAll("[data-session-dot]");
      const heroMode = document.getElementById("pomodoro-chip-mode");
      const heroRemaining = document.getElementById("pomodoro-chip-remaining");
      const heroSession = document.getElementById("pomodoro-chip-session");
      const heroToggle = document.querySelector("[data-timer-toggle]");
      const heroReset = document.querySelector("[data-timer-reset]");
      const heroSkip = document.querySelector("[data-timer-skip]");
      const taskClear = document.getElementById("task-clear");
      const startButton = document.getElementById("pomodoro-start");
      const pauseButton = document.getElementById("pomodoro-pause");
      const resetButton = document.getElementById("pomodoro-reset");
      const skipButton = document.getElementById("pomodoro-skip");
      const presetButtons = document.querySelectorAll("[data-pomodoro-mode]");
      const baseTitle = document.title;

      const presets = {
        work: 25 * 60,
        short: 5 * 60,
        long: 15 * 60,
      };

      const storageKey = "pomodoroState";
      let intervalId = null;
      let audioContext = null;

      const defaultState = {
        mode: "work",
        remaining: presets.work,
        isRunning: false,
        completedWork: 0,
        lastTick: null,
        taskId: null,
        taskRunning: false,
      };

      const loadState = () => {
        try {
          const raw = localStorage.getItem(storageKey);
          if (!raw) {
            return { ...defaultState };
          }
          const parsed = JSON.parse(raw);
          return {
            ...defaultState,
            ...parsed,
          };
        } catch (error) {
          return { ...defaultState };
        }
      };

      const saveState = (state) => {
        localStorage.setItem(storageKey, JSON.stringify(state));
      };

      const formatClock = (seconds) => {
        const safe = Math.max(0, Math.floor(seconds || 0));
        const minutes = Math.floor(safe / 60);
        const remaining = safe % 60;
        return `${String(minutes).padStart(2, "0")}:${String(remaining).padStart(2, "0")}`;
      };

      const modeLabel = (mode) => {
        if (mode === "short") {
          return "Short Break";
        }
        if (mode === "long") {
          return "Long Break";
        }
        return "Focus";
      };

      const updatePageTitle = (state) => {
        if (!state.isRunning) {
          document.title = baseTitle;
          return;
        }
        const time = formatClock(state.remaining);
        const mode = modeLabel(state.mode);
        const taskLabel = state.taskName ? ` - ${state.taskName}` : "";
        document.title = `${time} · ${mode}${taskLabel}`;
      };

      const updatePomodoroUI = (state) => {
        if (!pomodoroDisplay || !pomodoroMode || !pomodoroMeta) {
          return;
        }
        pomodoroDisplay.textContent = formatClock(state.remaining);
        pomodoroMode.textContent = modeLabel(state.mode);
        const nextSession = (state.completedWork % 4) + 1;
        pomodoroMeta.textContent = `Session ${nextSession} of 4`;
        if (pomodoroTask) {
          pomodoroTask.textContent = state.taskName
            ? `Task: ${state.taskName}`
            : "No task selected";
        }
        if (heroMode) {
          heroMode.textContent = modeLabel(state.mode);
        }
        if (heroRemaining) {
          heroRemaining.textContent = formatClock(state.remaining);
        }
        if (heroSession) {
          heroSession.textContent = `Session ${nextSession} / 4`;
        }
        if (pomodoroDots.length) {
          const completed = state.completedWork % 4;
          pomodoroDots.forEach((dot, index) => {
            dot.classList.toggle("is-active", index < completed);
            dot.classList.toggle("is-current", index === completed);
          });
        }
        if (pomodoroRing) {
          const total = presets[state.mode] || 0;
          const progress =
            total > 0 ? Math.min(1, Math.max(0, state.remaining / total)) : 0;
          pomodoroRing.style.setProperty("--pomodoro-progress", `${progress * 360}deg`);
        }
        const requiresTask = state.mode === "work" && !state.taskId;
        if (startButton) {
          startButton.disabled = state.isRunning || requiresTask;
        }
        if (pauseButton) {
          pauseButton.disabled = !state.isRunning;
        }
        if (heroToggle) {
          heroToggle.classList.toggle("is-running", state.isRunning);
          heroToggle.setAttribute("aria-pressed", state.isRunning ? "true" : "false");
          const label = heroToggle.querySelector(".timer-btn-label");
          if (label) {
            label.textContent = state.isRunning ? "Pause" : "Start";
          }
          heroToggle.disabled = !state.isRunning && requiresTask;
          heroToggle.title = requiresTask ? "Select a task to start focus." : "";
        }
        if (taskClear) {
          taskClear.disabled = !state.taskId;
        }
        updatePageTitle(state);
      };

      const getNextMode = (state) => {
        if (state.mode === "work") {
          const nextWork = state.completedWork + 1;
          return nextWork % 4 === 0 ? "long" : "short";
        }
        return "work";
      };

      const applyMode = (state, mode) => {
        const duration = presets[mode];
        return {
          ...state,
          mode,
          remaining: duration,
          isRunning: false,
          lastTick: null,
          taskRunning: false,
        };
      };

      const ensureAudioContext = () => {
        if (!audioContext) {
          const AudioCtx = window.AudioContext || window.webkitAudioContext;
          if (AudioCtx) {
            audioContext = new AudioCtx();
          }
        }
        return audioContext;
      };

      const playChime = () => {
        const ctx = ensureAudioContext();
        if (!ctx) {
          return;
        }
        const now = ctx.currentTime;
        const tones = [523.25, 659.25, 783.99];
        tones.forEach((freq, index) => {
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.type = "sine";
          osc.frequency.value = freq;
          gain.gain.setValueAtTime(0, now + index * 0.18);
          gain.gain.linearRampToValueAtTime(0.2, now + index * 0.18 + 0.02);
          gain.gain.exponentialRampToValueAtTime(0.001, now + index * 0.18 + 0.16);
          osc.connect(gain);
          gain.connect(ctx.destination);
          osc.start(now + index * 0.18);
          osc.stop(now + index * 0.18 + 0.2);
        });
      };

      const requestNotifications = () => {
        if (!("Notification" in window)) {
          return;
        }
        if (Notification.permission === "default") {
          Notification.requestPermission().catch(() => {});
        }
      };

      const sendNotification = (title, body) => {
        if (!("Notification" in window)) {
          return;
        }
        if (Notification.permission === "granted") {
          new Notification(title, { body });
        }
      };

      const notifyPomodoro = (completedMode, nextMode) => {
        const toastTitle = completedMode === "work" ? "Focus complete" : "Break complete";
        const toastBody =
          completedMode === "work" ? "Time for a break." : "Time to focus.";
        if (typeof window.showPomodoroToast === "function") {
          window.showPomodoroToast(toastTitle, toastBody);
        }
        if (completedMode === "work") {
          sendNotification("Focus complete", "Time for a break.");
        } else {
          sendNotification("Break complete", "Time to focus.");
        }
        playChime();
      };

      const applyElapsed = (state, elapsedSeconds) => {
        const startingRemaining = state.remaining;
        let remaining = state.remaining;
        let mode = state.mode;
        let completedWork = state.completedWork;
        let secondsLeft = elapsedSeconds;
        let completedAny = false;

        while (secondsLeft > 0) {
          if (remaining > secondsLeft) {
            remaining -= secondsLeft;
            secondsLeft = 0;
          } else {
            secondsLeft -= remaining;
            notifyPomodoro(mode, mode === "work" ? "break" : "work");
            if (mode === "work") {
              completedWork += 1;
            }
            mode = mode === "work" ? (completedWork % 4 === 0 ? "long" : "short") : "work";
            remaining = presets[mode];
            completedAny = true;
          }
        }

        state.remaining = remaining;
        state.mode = mode;
        state.completedWork = completedWork;
        if (elapsedSeconds >= startingRemaining) {
          state.isRunning = false;
          state.lastTick = null;
          state.taskRunning = false;
        }
        if (completedAny && state.mode !== "work") {
          state.isRunning = true;
          state.lastTick = Date.now();
        }
      };

      const stopInterval = () => {
        if (intervalId) {
          clearInterval(intervalId);
          intervalId = null;
        }
      };

      const startTaskTimer = async (state) => {
        if (!state.taskId || state.taskRunning) {
          return;
        }
        state.taskRunning = true;
        saveState(state);
        try {
          await fetch(`/api/tasks/${state.taskId}/start`, { method: "POST" });
        } catch (error) {
          state.taskRunning = false;
          saveState(state);
          console.error(error);
        }
      };

      const stopTaskTimer = async (state) => {
        if (!state.taskId || !state.taskRunning) {
          return;
        }
        state.taskRunning = false;
        saveState(state);
        try {
          await fetch(`/api/tasks/${state.taskId}/stop`, { method: "POST" });
        } catch (error) {
          console.error(error);
        }
      };

      const startInterval = (state) => {
        stopInterval();
        state.lastTick = Date.now();
        intervalId = setInterval(() => {
          const now = Date.now();
          const elapsed = Math.max(1, Math.floor((now - (state.lastTick || now)) / 1000));
          state.lastTick = now;
          state.remaining -= elapsed;
          if (state.remaining <= 0) {
            if (state.mode === "work") {
              stopTaskTimer(state);
            }
            notifyPomodoro(state.mode, getNextMode(state));
            state.remaining = 0;
            state.isRunning = false;
            if (state.mode === "work") {
              state.completedWork += 1;
            }
            const nextMode = getNextMode(state);
            const nextState = applyMode(state, nextMode);
            state.mode = nextState.mode;
            state.remaining = nextState.remaining;
            state.lastTick = null;
            stopInterval();
            if (nextMode !== "work") {
              state.isRunning = true;
              state.lastTick = Date.now();
              startInterval(state);
            }
          }
          saveState(state);
          updatePomodoroUI(state);
        }, 1000);
      };

      if (pomodoroDisplay) {
        const state = loadState();
        state.taskName = state.taskName || null;
        if (state.isRunning && state.lastTick) {
          const elapsed = Math.floor((Date.now() - state.lastTick) / 1000);
          if (elapsed > 0) {
            applyElapsed(state, elapsed);
          }
        }
        updatePomodoroUI(state);
        if (state.isRunning) {
          startInterval(state);
        }

        startButton?.addEventListener("click", () => {
          if (state.mode === "work" && !state.taskId) {
            alert("Select a task for this Pomodoro.");
            return;
          }
          requestNotifications();
          state.isRunning = true;
          state.lastTick = Date.now();
          if (state.mode === "work") {
            startTaskTimer(state);
          }
          saveState(state);
          updatePomodoroUI(state);
          startInterval(state);
        });

        pauseButton?.addEventListener("click", () => {
          state.isRunning = false;
          state.lastTick = null;
          stopTaskTimer(state);
          saveState(state);
          updatePomodoroUI(state);
          stopInterval();
        });

        resetButton?.addEventListener("click", () => {
          state.mode = "work";
          state.remaining = presets.work;
          state.isRunning = false;
          state.completedWork = 0;
          state.lastTick = null;
          stopTaskTimer(state);
          saveState(state);
          updatePomodoroUI(state);
          stopInterval();
        });

        skipButton?.addEventListener("click", () => {
          if (state.mode === "work") {
            state.completedWork += 1;
          }
          stopTaskTimer(state);
          const nextMode = getNextMode(state);
          const nextState = applyMode(state, nextMode);
          state.mode = nextState.mode;
          state.remaining = nextState.remaining;
          state.isRunning = false;
          state.lastTick = null;
          saveState(state);
          updatePomodoroUI(state);
          stopInterval();
        });

        presetButtons.forEach((button) => {
          button.addEventListener("click", () => {
            const mode = button.dataset.pomodoroMode;
            if (!mode || !presets[mode]) {
              return;
            }
            stopTaskTimer(state);
            state.mode = mode;
            state.remaining = presets[mode];
            state.isRunning = false;
            state.lastTick = null;
            saveState(state);
            updatePomodoroUI(state);
            stopInterval();
          });
        });

        heroToggle?.addEventListener("click", () => {
          if (state.isRunning) {
            pauseButton?.click();
          } else {
            startButton?.click();
          }
        });

        heroReset?.addEventListener("click", () => {
          resetButton?.click();
        });

        heroSkip?.addEventListener("click", () => {
          skipButton?.click();
        });

        taskClear?.addEventListener("click", () => {
          if (state.isRunning && state.mode === "work") {
            pauseButton?.click();
          }
          state.taskId = null;
          state.taskName = null;
          if (taskPicker) {
            taskPicker.value = "";
          }
          if (taskSearch) {
            taskSearch.value = "";
          }
          if (cachedTasks.length) {
            renderTasks(cachedTasks, "");
          }
          saveState(state);
          updatePomodoroUI(state);
        });

        const formatSeconds = (totalSeconds) => {
          const safe = Math.max(0, Math.floor(totalSeconds || 0));
          const hours = Math.floor(safe / 3600);
          const minutes = Math.floor((safe % 3600) / 60);
          const seconds = safe % 60;
          return `${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;
        };

        const escapeHtml = (value) => {
          const div = document.createElement("div");
          div.textContent = value;
          return div.innerHTML;
        };

        const renderTasks = (tasks, query) => {
          if (!taskList) {
            return;
          }
          const term = (query || "").toLowerCase();
          const filtered = tasks.filter((task) => {
            const name = (task.name || "").toLowerCase();
            const project = (task.project_name || "").toLowerCase();
            return !term || name.includes(term) || project.includes(term);
          });
          if (!filtered.length) {
            taskList.innerHTML = "<div class=\"timer-empty-state\">No tasks found.</div>";
            return;
          }
          taskList.innerHTML = filtered
            .map((task) => {
              const name = escapeHtml(task.name || "");
              const projectName = task.project_name ? escapeHtml(task.project_name) : "";
              const project = projectName ? ` • ${projectName}` : "";
              const total = formatSeconds(task.total_seconds || 0);
              return `<button type="button" data-task-id="${task.id}">${name}${project} · ${total}</button>`;
            })
            .join("");
        };

        const openDropdown = () => {
          taskDropdown?.classList.add("is-open");
          taskPicker?.setAttribute("aria-expanded", "true");
        };

        const closeDropdown = () => {
          taskDropdown?.classList.remove("is-open");
          taskPicker?.setAttribute("aria-expanded", "false");
        };

        if (taskPicker && taskDropdown && taskSearch && taskList) {
          fetch("/api/tasks")
            .then((response) => response.json())
            .then((payload) => {
              cachedTasks = (payload.tasks || []).sort(
                (a, b) => (b.total_seconds || 0) - (a.total_seconds || 0),
              );
              if (state.taskId) {
                const current = cachedTasks.find(
                  (task) => String(task.id) === String(state.taskId),
                );
                if (current) {
                  taskPicker.value = current.name;
                  state.taskName = current.name;
                  updatePomodoroUI(state);
                }
              }
              renderTasks(cachedTasks, taskSearch.value);

              taskPicker.addEventListener("focus", () => {
                openDropdown();
              });

              taskPicker.addEventListener("click", () => {
                openDropdown();
              });

              taskPicker.addEventListener("keydown", (event) => {
                if (event.key === "ArrowDown") {
                  event.preventDefault();
                  openDropdown();
                  taskSearch?.focus();
                }
                if (event.key === "Escape") {
                  closeDropdown();
                }
              });

              taskSearch.addEventListener("input", () => {
                renderTasks(cachedTasks, taskSearch.value);
              });

              taskSearch.addEventListener("keydown", (event) => {
                if (event.key === "Escape") {
                  closeDropdown();
                  taskPicker.focus();
                }
              });

              taskList.addEventListener("click", (event) => {
                const target = event.target;
                if (!(target instanceof HTMLElement)) {
                  return;
                }
                const button = target.closest("button[data-task-id]");
                if (!button) {
                  return;
                }
                const taskId = button.dataset.taskId;
                const selected = cachedTasks.find(
                  (task) => String(task.id) === String(taskId),
                );
                if (!selected) {
                  return;
                }
                const previousTaskId = state.taskId;
                state.taskId = selected.id;
                state.taskName = selected.name;
                taskPicker.value = selected.name;
                taskSearch.value = "";
                renderTasks(cachedTasks, "");
                closeDropdown();
                saveState(state);
                updatePomodoroUI(state);

                if (state.isRunning && state.mode === "work") {
                  if (previousTaskId && previousTaskId !== state.taskId) {
                    stopTaskTimer(state);
                  }
                  startTaskTimer(state);
                }
              });

              document.addEventListener("click", (event) => {
                if (!(event.target instanceof HTMLElement)) {
                  return;
                }
                if (
                  !event.target.closest(".timer-select") &&
                  !event.target.closest(".timer-dropdown")
                ) {
                  closeDropdown();
                }
              });
            })
            .catch((error) => {
              console.error(error);
            });
        }
      }
    });
  </script>
{% endblock %}
