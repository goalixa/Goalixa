{% extends "layout.html" %}
{% set title = "Weekly Goals" %}
{% set active_page = "weekly_goals" %}

{% block content %}
  <div class="container py-4 weekly-goals-page">
    <header class="header goals-header-bar">
      <div>
        <h1>Weekly goals</h1>
        <p>Set a focused target for the week and track progress.</p>
      </div>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('goals') }}">
        <i class="bi bi-bullseye"></i>
        Back to goals
      </a>
    </header>

    <section class="card weekly-goals-card">
      <div class="goals-header">
        <div>
          <p class="goals-label">This week</p>
          <h2 class="goals-title">{{ weekly_range_label }}</h2>
        </div>
      </div>
      <form class="weekly-goal-form" method="post" action="{{ url_for('create_weekly_goal') }}">
        <input type="hidden" name="week_start" value="{{ week_start }}" />
        <input type="hidden" name="week_end" value="{{ week_end }}" />
        <label>
          Goal title
          <input type="text" name="title" placeholder="Complete 10h of deep work" required />
        </label>
        <label>
          Target hours
          <input type="number" name="target_hours" min="0" step="0.5" placeholder="10" />
        </label>
        <button class="btn btn-primary btn-sm" type="submit">
          <i class="bi bi-plus-lg"></i>
          Add weekly goal
        </button>
      </form>
      <div class="weekly-goals-list">
        {% if weekly_goals_current %}
          {% for goal in weekly_goals_current %}
            <div class="weekly-goal-item">
              <div class="weekly-goal-info">
                <div>
                  <h3>{{ goal["title"] }}</h3>
                  <p>
                    {{ goal["progress_seconds"] | format_seconds }} logged ·
                    Target {{ ((goal["target_seconds"] / 3600) | round(1)) if goal["target_seconds"] else 0 }}h
                  </p>
                </div>
                <div class="weekly-goal-actions">
                  {% if goal["status"] != "completed" %}
                    <form method="post" action="{{ url_for('toggle_weekly_goal', goal_id=goal['id']) }}">
                      <input type="hidden" name="status" value="completed" />
                      <button class="btn btn-outline-success btn-sm" type="submit">Done</button>
                    </form>
                  {% else %}
                    <form method="post" action="{{ url_for('toggle_weekly_goal', goal_id=goal['id']) }}">
                      <input type="hidden" name="status" value="active" />
                      <button class="btn btn-outline-secondary btn-sm" type="submit">Reopen</button>
                    </form>
                  {% endif %}
                  <form method="post" action="{{ url_for('delete_weekly_goal', goal_id=goal['id']) }}">
                    <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
                  </form>
                </div>
              </div>
              <div class="weekly-goal-progress">
                <div class="weekly-goal-bar">
                  <span style="width: {{ goal['progress_percent'] }}%"></span>
                </div>
                <span>{{ goal["progress_percent"] }}%</span>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="empty">No weekly goals yet.</p>
        {% endif %}
      </div>
    </section>

    <section class="card weekly-goals-history">
      <div class="goals-header">
        <div>
          <p class="goals-label">History</p>
          <h2 class="goals-title">Previous weeks</h2>
        </div>
      </div>
      <div class="weekly-history-list">
        {% if weekly_goals_all %}
          {% for group in weekly_goals_all | groupby("week_start") %}
            <div class="weekly-history-group">
              <div class="weekly-history-header">
                <h3>{{ group.list[0]["week_label"] }}</h3>
                <span>{{ group.list | length }} goals</span>
              </div>
              <div class="weekly-goals-list">
                {% for goal in group.list %}
                  <div class="weekly-goal-item">
                    <div class="weekly-goal-info">
                      <div>
                        <h3>{{ goal["title"] }}</h3>
                        <p>
                          {{ goal["progress_seconds"] | format_seconds }} logged ·
                          Target {{ ((goal["target_seconds"] / 3600) | round(1)) if goal["target_seconds"] else 0 }}h
                        </p>
                      </div>
                      <div class="weekly-goal-actions">
                        {% if goal["status"] != "completed" %}
                          <form method="post" action="{{ url_for('toggle_weekly_goal', goal_id=goal['id']) }}">
                            <input type="hidden" name="status" value="completed" />
                            <button class="btn btn-outline-success btn-sm" type="submit">Done</button>
                          </form>
                        {% else %}
                          <form method="post" action="{{ url_for('toggle_weekly_goal', goal_id=goal['id']) }}">
                            <input type="hidden" name="status" value="active" />
                            <button class="btn btn-outline-secondary btn-sm" type="submit">Reopen</button>
                          </form>
                        {% endif %}
                        <form method="post" action="{{ url_for('delete_weekly_goal', goal_id=goal['id']) }}">
                          <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
                        </form>
                      </div>
                    </div>
                    <div class="weekly-goal-progress">
                      <div class="weekly-goal-bar">
                        <span style="width: {{ goal['progress_percent'] }}%"></span>
                      </div>
                      <span>{{ goal["progress_percent"] }}%</span>
                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        {% else %}
          <p class="empty">No weekly goals yet.</p>
        {% endif %}
      </div>
    </section>
  </div>
{% endblock %}
