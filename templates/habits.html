{% extends "layout.html" %}
{% set title = "Habits" %}
{% set active_page = "habits" %}

{% block content %}
  <div class="container py-4 habits-page">
    <header class="header habits-header">
      <div>
        <h1>Habits</h1>
        <p>Track daily routines and close the day with a clear checklist.</p>
      </div>
      <div class="habits-header-actions">
        <button class="btn btn-primary btn-sm" type="button" data-habit-toggle aria-expanded="false">
          <i class="bi bi-plus-lg"></i>
          Create habit
        </button>
        <div class="habit-create-panel is-hidden" id="habit-create">
          <form class="habit-form" id="habit-form" method="post" action="{{ url_for('create_habit') }}">
            <div class="goal-form-row">
              <label>
                Habit name
                <input type="text" name="name" placeholder="Review day plan" required />
              </label>
              <label>
                Frequency
                <select name="frequency">
                  <option value="Daily">Daily</option>
                  <option value="Weekdays">Weekdays</option>
                  <option value="Weekends">Weekends</option>
                  <option value="Custom">Custom</option>
                </select>
              </label>
            </div>
            <div class="goal-form-row">
              <label class="habit-goal-field">
                Goal
                <div class="habit-goal-select">
                  <select name="goal_name">
                    <option value="">Select a goal</option>
                    {% for goal in goals %}
                      <option value="{{ goal['name'] }}" data-goal-id="{{ goal['id'] }}">{{ goal['name'] }}</option>
                    {% endfor %}
                  </select>
                  <button class="btn btn-outline-danger btn-sm habit-goal-delete" type="button" data-goal-delete>
                    <i class="bi bi-trash"></i>
                    Delete goal
                  </button>
                </div>
              </label>
              <label>
                Sub-goal
                <select name="subgoal_name">
                  <option value="">Select a sub-goal</option>
                  {% for goal in goals %}
                    {% if goal['subgoals'] %}
                      <optgroup label="{{ goal['name'] }}">
                        {% for subgoal in goal['subgoals'] %}
                          <option value="{{ subgoal['title'] }}">{{ subgoal['title'] }}</option>
                        {% endfor %}
                      </optgroup>
                    {% endif %}
                  {% endfor %}
                </select>
              </label>
            </div>
            <div class="goal-form-row">
              <label>
                Best time
                <select name="time_of_day">
                  <option value="">Anytime</option>
                  <option value="Morning">Morning</option>
                  <option value="Afternoon">Afternoon</option>
                  <option value="Evening">Evening</option>
                </select>
              </label>
              <label>
                Reminder
                <select name="reminder">
                  <option value="">None</option>
                  <option value="21:00">21:00</option>
                  <option value="22:30">22:30</option>
                </select>
              </label>
            </div>
            <label>
              Notes
              <textarea rows="2" name="notes" placeholder="Why is this habit important?"></textarea>
            </label>
            <div class="goal-form-actions habit-form-actions">
              <button class="btn btn-outline-secondary btn-sm" type="reset">Reset</button>
              <button class="btn btn-primary btn-sm" type="submit">Create habit</button>
            </div>
          </form>
        </div>
      </div>
    </header>

    <section class="habits-hero">
      <div class="habit-stat-card">
        <span class="habit-stat-label">Completed today</span>
        <span class="habit-stat-value">{{ completed_habits or 0 }}</span>
        <span class="habit-stat-meta">Out of {{ total_habits or 0 }}</span>
      </div>
      <div class="habit-stat-card">
        <span class="habit-stat-label">Daily streak</span>
        <span class="habit-stat-value">{{ best_streak or 0 }} days</span>
        <span class="habit-stat-meta">Best active chain</span>
      </div>
      <div class="habit-stat-card">
        <span class="habit-stat-label">Focus ritual</span>
        <span class="habit-stat-value">{{ focus_window or "Night close" }}</span>
        <span class="habit-stat-meta">Mark done before sleep</span>
      </div>
    </section>

    <section class="card habits-card">
      <div class="habits-card-header">
        <div>
          <p class="goals-label">Tonight</p>
          <h2 class="goals-title">Daily checklist</h2>
        </div>
        <button class="btn btn-outline-secondary btn-sm" type="button">
          <i class="bi bi-calendar-check"></i>
          Mark all complete
        </button>
      </div>
      <div class="habit-list" id="habit-list">
        {% if habits %}
          {% for habit in habits %}
            <div class="habit-item">
              <div class="habit-row {% if habit['done'] %}is-done{% endif %}">
                <form class="habit-toggle" method="post" action="{{ url_for('toggle_habit', habit_id=habit['id']) }}">
                  <input type="hidden" name="date" value="{{ today }}" />
                  <label class="habit-left">
                    <span class="habit-checkbox">
                      <input type="checkbox" name="done" {% if habit['done'] %}checked{% endif %} onchange="this.form.submit()" />
                      <span class="habit-checkmark"></span>
                    </span>
                    <span class="habit-text">
                      <span class="habit-name">{{ habit['name'] }}</span>
                      <span class="habit-meta">{{ habit['meta'] }}</span>
                    </span>
                  </label>
                </form>
                <div class="habit-actions">
                  <span class="habit-streak">
                    <i class="bi bi-fire"></i>
                    {{ habit['streak'] }} day streak
                  </span>
                  <button class="icon-button edit-toggle" type="button" aria-label="Edit habit" data-edit-target="edit-habit-{{ habit['id'] }}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <form class="inline-form" method="post" action="{{ url_for('delete_habit', habit_id=habit['id']) }}">
                    <button class="icon-button danger" type="submit" aria-label="Delete habit">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </div>
              </div>
              <form id="edit-habit-{{ habit['id'] }}" class="edit-form habit-edit-form" method="post" action="{{ url_for('update_habit', habit_id=habit['id']) }}">
                <div class="goal-form-row">
                  <label>
                    Habit name
                    <input type="text" name="name" value="{{ habit['name'] }}" required />
                  </label>
                  <label>
                    Frequency
                    <select name="frequency">
                      <option value="Daily" {% if habit['frequency'] == 'Daily' %}selected{% endif %}>Daily</option>
                      <option value="Weekdays" {% if habit['frequency'] == 'Weekdays' %}selected{% endif %}>Weekdays</option>
                      <option value="Weekends" {% if habit['frequency'] == 'Weekends' %}selected{% endif %}>Weekends</option>
                      <option value="Custom" {% if habit['frequency'] == 'Custom' %}selected{% endif %}>Custom</option>
                    </select>
                  </label>
                </div>
                <div class="goal-form-row">
                  <label class="habit-goal-field">
                    Goal
                    <div class="habit-goal-select">
                      <select name="goal_name">
                        <option value="">Select a goal</option>
                        {% for goal in goals %}
                          <option value="{{ goal['name'] }}" data-goal-id="{{ goal['id'] }}" {% if habit['goal_name'] == goal['name'] %}selected{% endif %}>
                            {{ goal['name'] }}
                          </option>
                        {% endfor %}
                      </select>
                      <button class="btn btn-outline-danger btn-sm habit-goal-delete" type="button" data-goal-delete>
                        <i class="bi bi-trash"></i>
                        Delete goal
                      </button>
                    </div>
                  </label>
                  <label>
                    Sub-goal
                    <select name="subgoal_name">
                      <option value="">Select a sub-goal</option>
                      {% for goal in goals %}
                        {% if goal['subgoals'] %}
                          <optgroup label="{{ goal['name'] }}">
                            {% for subgoal in goal['subgoals'] %}
                              <option value="{{ subgoal['title'] }}" {% if habit['subgoal_name'] == subgoal['title'] %}selected{% endif %}>
                                {{ subgoal['title'] }}
                              </option>
                            {% endfor %}
                          </optgroup>
                        {% endif %}
                      {% endfor %}
                    </select>
                  </label>
                </div>
                <div class="goal-form-row">
                  <label>
                    Best time
                    <select name="time_of_day">
                      <option value="" {% if not habit['time_of_day'] %}selected{% endif %}>Anytime</option>
                      <option value="Morning" {% if habit['time_of_day'] == 'Morning' %}selected{% endif %}>Morning</option>
                      <option value="Afternoon" {% if habit['time_of_day'] == 'Afternoon' %}selected{% endif %}>Afternoon</option>
                      <option value="Evening" {% if habit['time_of_day'] == 'Evening' %}selected{% endif %}>Evening</option>
                    </select>
                  </label>
                  <label>
                    Reminder
                    <select name="reminder">
                      <option value="" {% if not habit['reminder'] %}selected{% endif %}>None</option>
                      <option value="21:00" {% if habit['reminder'] == '21:00' %}selected{% endif %}>21:00</option>
                      <option value="22:30" {% if habit['reminder'] == '22:30' %}selected{% endif %}>22:30</option>
                    </select>
                  </label>
                </div>
                <label>
                  Notes
                  <textarea rows="2" name="notes">{{ habit['notes'] or '' }}</textarea>
                </label>
                <div class="goal-form-actions">
                  <button class="btn btn-outline-secondary btn-sm" type="submit">Save changes</button>
                </div>
              </form>
            </div>
          {% endfor %}
        {% else %}
          <p class="empty">No habits yet.</p>
        {% endif %}
      </div>
    </section>

  </div>
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const toggleButton = document.querySelector("[data-habit-toggle]");
      const createPanel = document.getElementById("habit-create");
      if (toggleButton && createPanel) {
        toggleButton.addEventListener("click", () => {
          const isHidden = createPanel.classList.toggle("is-hidden");
          toggleButton.setAttribute("aria-expanded", String(!isHidden));
          if (!isHidden) {
            const input = createPanel.querySelector('input[name="name"]');
            if (input) {
              input.focus();
            }
          }
        });
      }
      const form = document.getElementById("habit-form");
      if (form && createPanel && toggleButton) {
        form.addEventListener("submit", () => {
          createPanel.classList.add("is-hidden");
          toggleButton.setAttribute("aria-expanded", "false");
        });
      }

      document.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        const deleteButton = target.closest("[data-goal-delete]");
        if (deleteButton) {
          const wrapper = deleteButton.closest(".habit-goal-select");
          const select = wrapper?.querySelector("select");
          const selected = select?.selectedOptions?.[0];
          const goalId = selected?.dataset?.goalId;
          if (!goalId) {
            return;
          }
          const confirmed = window.confirm("Delete selected goal?");
          if (!confirmed) {
            return;
          }
          const form = document.createElement("form");
          form.method = "post";
          form.action = `/goals/${goalId}/delete`;
          document.body.appendChild(form);
          form.submit();
          return;
        }
        const editButton = target.closest("[data-edit-target]");
        if (editButton) {
          event.preventDefault();
          const targetId = editButton.dataset.editTarget;
          const form = document.getElementById(targetId);
          if (!form) {
            return;
          }
          const isOpen = form.classList.contains("is-open");
          document.querySelectorAll(".habit-edit-form.is-open").forEach((openForm) => {
            if (openForm !== form) {
              openForm.classList.remove("is-open");
            }
          });
          form.classList.toggle("is-open", !isOpen);
          if (!isOpen) {
            const input = form.querySelector('input[type="text"]');
            if (input) {
              input.focus();
              input.select();
            }
          }
          return;
        }
        if (!target.closest(".habit-edit-form")) {
          document.querySelectorAll(".habit-edit-form.is-open").forEach((openForm) => {
            openForm.classList.remove("is-open");
          });
        }
      });

      document.addEventListener("keydown", (event) => {
        if (event.key !== "Escape") {
          return;
        }
        document.querySelectorAll(".habit-edit-form.is-open").forEach((openForm) => {
          openForm.classList.remove("is-open");
        });
      });
    });
  </script>
{% endblock %}
