{% extends "layout.html" %}
{% set title = "Habits" %}
{% set active_page = "habits" %}

{% block content %}
  <div class="container py-4 habits-page">
    <header class="header habits-header">
      <div>
        <h1>Habits</h1>
        <p>Track daily routines and close the day with a clear checklist.</p>
      </div>
      <div class="habits-header-actions">
        <a class="btn btn-primary btn-sm" href="{{ url_for('new_habit') }}">
          <i class="bi bi-plus-lg"></i>
          Create habit
        </a>
      </div>
    </header>

    <section class="habits-hero">
      <div class="habit-stat-card">
        <span class="habit-stat-label">Completed today</span>
        <span class="habit-stat-value">{{ completed_habits or 0 }}</span>
        <span class="habit-stat-meta">Out of {{ total_habits or 0 }}</span>
      </div>
      <div class="habit-stat-card">
        <span class="habit-stat-label">Daily streak</span>
        <span class="habit-stat-value">{{ best_streak or 0 }} days</span>
        <span class="habit-stat-meta">Best active chain</span>
      </div>
      <div class="habit-stat-card">
        <span class="habit-stat-label">Focus ritual</span>
        <span class="habit-stat-value">{{ focus_window or "Night close" }}</span>
        <span class="habit-stat-meta">Mark done before sleep</span>
      </div>
    </section>

    <section class="card habits-card" data-tour-id="habits-checklist">
      <div class="habits-card-header">
        <div>
          <p class="goals-label">Tonight</p>
          <h2 class="goals-title">Daily checklist</h2>
        </div>
        <button class="btn btn-outline-secondary btn-sm" type="button">
          <i class="bi bi-calendar-check"></i>
          Mark all complete
        </button>
      </div>
      <div class="habit-list" id="habit-list">
        {% if habits %}
          {% for habit in habits %}
            <div class="habit-item">
              <div class="habit-row {% if habit['done'] %}is-done{% endif %}">
                <form class="habit-toggle" method="post" action="{{ url_for('toggle_habit', habit_id=habit['id']) }}">
                  <input type="hidden" name="date" value="{{ today }}" />
                  <label class="habit-left">
                    <span class="habit-checkbox">
                      <input type="checkbox" name="done" {% if habit['done'] %}checked{% endif %} onchange="this.form.submit()" />
                      <span class="habit-checkmark"></span>
                    </span>
                    <span class="habit-text">
                      <span class="habit-name">{{ habit['name'] }}</span>
                      <span class="habit-meta">{{ habit['meta'] }}</span>
                    </span>
                  </label>
                </form>
                <div class="habit-actions">
                  <span class="habit-streak">
                    <i class="bi bi-fire"></i>
                    {{ habit['streak'] }} day streak
                  </span>
                  <button class="icon-button edit-toggle" type="button" aria-label="Edit habit" data-edit-target="edit-habit-{{ habit['id'] }}">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <form class="inline-form" method="post" action="{{ url_for('delete_habit', habit_id=habit['id']) }}">
                    <button class="icon-button danger" type="submit" aria-label="Delete habit">
                      <i class="bi bi-trash"></i>
                    </button>
                  </form>
                </div>
              </div>
              <form id="edit-habit-{{ habit['id'] }}" class="edit-form habit-edit-form" method="post" action="{{ url_for('update_habit', habit_id=habit['id']) }}">
                <div class="goal-form-row">
                  <label>
                    Habit name
                    <input type="text" name="name" value="{{ habit['name'] }}" required />
                  </label>
                  <label>
                    Frequency
                    <select name="frequency">
                      <option value="Daily" {% if habit['frequency'] == 'Daily' %}selected{% endif %}>Daily</option>
                      <option value="Weekdays" {% if habit['frequency'] == 'Weekdays' %}selected{% endif %}>Weekdays</option>
                      <option value="Weekends" {% if habit['frequency'] == 'Weekends' %}selected{% endif %}>Weekends</option>
                      <option value="Custom" {% if habit['frequency'] == 'Custom' %}selected{% endif %}>Custom</option>
                    </select>
                  </label>
                </div>
                <div class="goal-form-row">
                  <label class="habit-goal-field">
                    Goal
                    <div class="habit-goal-select">
                      <select name="goal_name">
                        <option value="">Select a goal</option>
                        {% for goal in goals %}
                          <option value="{{ goal['name'] }}" data-goal-id="{{ goal['id'] }}" {% if habit['goal_name'] == goal['name'] %}selected{% endif %}>
                            {{ goal['name'] }}
                          </option>
                        {% endfor %}
                      </select>
                      <button class="btn btn-outline-danger btn-sm habit-goal-delete" type="button" data-goal-delete>
                        <i class="bi bi-trash"></i>
                        Delete goal
                      </button>
                    </div>
                  </label>
                  <label>
                    Sub-goal
                    <select name="subgoal_name">
                      <option value="">Select a sub-goal</option>
                      {% for goal in goals %}
                        {% if goal['subgoals'] %}
                          <optgroup label="{{ goal['name'] }}">
                            {% for subgoal in goal['subgoals'] %}
                              <option value="{{ subgoal['title'] }}" {% if habit['subgoal_name'] == subgoal['title'] %}selected{% endif %}>
                                {{ subgoal['title'] }}
                              </option>
                            {% endfor %}
                          </optgroup>
                        {% endif %}
                      {% endfor %}
                    </select>
                  </label>
                </div>
                <div class="goal-form-row">
                  <label>
                    Best time
                    <select name="time_of_day">
                      <option value="" {% if not habit['time_of_day'] %}selected{% endif %}>Anytime</option>
                      <option value="Morning" {% if habit['time_of_day'] == 'Morning' %}selected{% endif %}>Morning</option>
                      <option value="Afternoon" {% if habit['time_of_day'] == 'Afternoon' %}selected{% endif %}>Afternoon</option>
                      <option value="Evening" {% if habit['time_of_day'] == 'Evening' %}selected{% endif %}>Evening</option>
                    </select>
                  </label>
                  <label>
                    Reminder
                    <select name="reminder">
                      <option value="" {% if not habit['reminder'] %}selected{% endif %}>None</option>
                      <option value="21:00" {% if habit['reminder'] == '21:00' %}selected{% endif %}>21:00</option>
                      <option value="22:30" {% if habit['reminder'] == '22:30' %}selected{% endif %}>22:30</option>
                    </select>
                  </label>
                </div>
                <label>
                  Notes
                  <textarea rows="2" name="notes">{{ habit['notes'] or '' }}</textarea>
                </label>
                <div class="goal-form-actions">
                  <button class="btn btn-outline-secondary btn-sm" type="submit">Save changes</button>
                </div>
              </form>
            </div>
          {% endfor %}
        {% else %}
          <p class="empty">No habits yet.</p>
        {% endif %}
      </div>
    </section>

    <section class="card habits-chart">
      <div class="habits-card-header">
        <div>
          <p class="goals-label">Progress</p>
          <h2 class="goals-title">Habit completion over time</h2>
        </div>
        <span class="habit-chart-note">Last 14 days</span>
      </div>
      <div class="chart-panel is-active">
        <canvas id="habits-chart" height="160"></canvas>
      </div>
    </section>

  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script id="habit-series-data" type="application/json">{{ habit_series | tojson }}</script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const habitsPage = document.querySelector(".habits-page");
      if (!habitsPage) {
        return;
      }

      const deleteGoalUrlTemplate = {{ url_for('delete_goal', goal_id=0) | tojson }};
      const buildGoalDeleteUrl = (goalId) =>
        deleteGoalUrlTemplate.replace("/0/delete", `/${goalId}/delete`);

      const parseHabitSeries = (rootDocument = document) => {
        const seriesEl = rootDocument.getElementById("habit-series-data");
        if (!seriesEl) {
          return { labels: [], values: [] };
        }
        try {
          const parsed = JSON.parse(seriesEl.textContent || "{}");
          return {
            labels: Array.isArray(parsed.labels) ? parsed.labels : [],
            values: Array.isArray(parsed.values) ? parsed.values : [],
          };
        } catch (error) {
          return { labels: [], values: [] };
        }
      };

      const updateHabitsContentFromDocument = (nextDoc) => {
        const nextHero = nextDoc.querySelector(".habits-hero");
        const nextList = nextDoc.querySelector("#habit-list");
        const currentHero = habitsPage.querySelector(".habits-hero");
        const currentList = habitsPage.querySelector("#habit-list");
        if (!nextHero || !nextList || !currentHero || !currentList) {
          throw new Error("Habit content not found");
        }

        currentHero.replaceWith(nextHero);
        currentList.replaceWith(nextList);
        renderHabitChart(parseHabitSeries(nextDoc));
      };

      const updateHabitsContentFromHtml = (html) => {
        const nextDoc = new DOMParser().parseFromString(html, "text/html");
        updateHabitsContentFromDocument(nextDoc);
      };

      document.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        const deleteButton = target.closest("[data-goal-delete]");
        if (deleteButton) {
          const wrapper = deleteButton.closest(".habit-goal-select");
          const select = wrapper?.querySelector("select");
          const selected = select?.selectedOptions?.[0];
          const goalId = selected?.dataset?.goalId;
          if (!goalId) {
            return;
          }
          const confirmed = window.confirm("Delete selected goal?");
          if (!confirmed) {
            return;
          }
          const actionUrl = buildGoalDeleteUrl(goalId);
          (async () => {
            try {
              const response = await fetch(actionUrl, {
                method: "POST",
                headers: { "X-Requested-With": "XMLHttpRequest" },
              });
              if (!response.ok) {
                throw new Error("Goal delete failed");
              }
              const html = await response.text();
              updateHabitsContentFromHtml(html);
            } catch (error) {
              const form = document.createElement("form");
              form.method = "post";
              form.action = actionUrl;
              document.body.appendChild(form);
              form.submit();
            }
          })();
          return;
        }
        const editButton = target.closest("[data-edit-target]");
        if (editButton) {
          event.preventDefault();
          const targetId = editButton.dataset.editTarget;
          const form = document.getElementById(targetId);
          if (!form) {
            return;
          }
          const isOpen = form.classList.contains("is-open");
          document.querySelectorAll(".habit-edit-form.is-open").forEach((openForm) => {
            if (openForm !== form) {
              openForm.classList.remove("is-open");
            }
          });
          form.classList.toggle("is-open", !isOpen);
          if (!isOpen) {
            const input = form.querySelector('input[type="text"]');
            if (input) {
              input.focus();
              input.select();
            }
          }
          return;
        }
        if (!target.closest(".habit-edit-form")) {
          document.querySelectorAll(".habit-edit-form.is-open").forEach((openForm) => {
            openForm.classList.remove("is-open");
          });
        }
      });

      document.addEventListener("keydown", (event) => {
        if (event.key !== "Escape") {
          return;
        }
        document.querySelectorAll(".habit-edit-form.is-open").forEach((openForm) => {
          openForm.classList.remove("is-open");
        });
      });

      const chartEl = document.getElementById("habits-chart");
      let habitChart = null;
      const getChartTheme = () => {
        const isDark = document.documentElement.getAttribute("data-theme") === "dark";
        return {
          line: isDark ? "#8fb1ff" : "#1f6feb",
          fill: isDark ? "rgba(90, 141, 255, 0.25)" : "rgba(31, 111, 235, 0.15)",
          point: isDark ? "#8fb1ff" : "#1f6feb",
          grid: isDark ? "rgba(255, 255, 255, 0.08)" : "rgba(15, 23, 42, 0.1)",
          text: isDark ? "#cbd5f5" : "#1f2937",
          tooltipBg: isDark ? "#111827" : "#ffffff",
          tooltipBorder: isDark ? "#2a3342" : "#e2e8f0",
        };
      };
      const applyChartTheme = (chart) => {
        const theme = getChartTheme();
        if (!chart) {
          return;
        }
        chart.data.datasets[0].borderColor = theme.line;
        chart.data.datasets[0].backgroundColor = theme.fill;
        chart.data.datasets[0].pointBackgroundColor = theme.point;
        chart.options.scales.x.ticks.color = theme.text;
        chart.options.scales.y.ticks.color = theme.text;
        chart.options.scales.x.grid.color = theme.grid;
        chart.options.scales.y.grid.color = theme.grid;
        chart.options.plugins.tooltip.backgroundColor = theme.tooltipBg;
        chart.options.plugins.tooltip.borderColor = theme.tooltipBorder;
        chart.options.plugins.tooltip.titleColor = theme.text;
        chart.options.plugins.tooltip.bodyColor = theme.text;
        chart.update();
      };
      const renderHabitChart = (series) => {
        if (!chartEl || typeof Chart === "undefined") {
          return;
        }
        const labels = Array.isArray(series?.labels) ? series.labels : [];
        const values = Array.isArray(series?.values) ? series.values : [];
        const theme = getChartTheme();
        if (!habitChart) {
          const ctx = chartEl.getContext("2d");
          habitChart = new Chart(ctx, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "Completion %",
                  data: values,
                  borderColor: theme.line,
                  backgroundColor: theme.fill,
                  fill: true,
                  tension: 0.35,
                  pointRadius: 3,
                  pointBackgroundColor: theme.point,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  ticks: {
                    color: theme.text,
                  },
                  grid: {
                    color: theme.grid,
                  },
                },
                y: {
                  min: 0,
                  max: 100,
                  ticks: {
                    color: theme.text,
                    callback: (value) => `${value}%`,
                  },
                  grid: {
                    color: theme.grid,
                  },
                },
              },
              plugins: {
                legend: {
                  display: false,
                },
                tooltip: {
                  backgroundColor: theme.tooltipBg,
                  borderColor: theme.tooltipBorder,
                  borderWidth: 1,
                  titleColor: theme.text,
                  bodyColor: theme.text,
                  callbacks: {
                    label: (context) => `${context.parsed.y}% complete`,
                  },
                },
              },
            },
          });
          return;
        }

        habitChart.data.labels = labels;
        habitChart.data.datasets[0].data = values;
        applyChartTheme(habitChart);
      };

      renderHabitChart(parseHabitSeries());

      let isSubmitting = false;
      document.addEventListener("submit", async (event) => {
        const form = event.target;
        if (!(form instanceof HTMLFormElement)) {
          return;
        }
        if (!form.closest(".habits-page")) {
          return;
        }
        if ((form.method || "").toUpperCase() !== "POST") {
          return;
        }

        event.preventDefault();
        if (isSubmitting) {
          return;
        }
        if (form.action.includes("/habits/") && form.action.includes("/delete")) {
          if (!window.confirm("Delete this habit?")) {
            return;
          }
        }

        isSubmitting = true;
        const submitter = event.submitter;
        if (submitter instanceof HTMLButtonElement) {
          submitter.disabled = true;
        }

        try {
          const response = await fetch(form.action, {
            method: "POST",
            body: new FormData(form),
            headers: { "X-Requested-With": "XMLHttpRequest" },
          });
          if (!response.ok) {
            throw new Error("Habit action failed");
          }
          const html = await response.text();
          updateHabitsContentFromHtml(html);
        } catch (error) {
          HTMLFormElement.prototype.submit.call(form);
        } finally {
          isSubmitting = false;
          if (submitter instanceof HTMLButtonElement) {
            submitter.disabled = false;
          }
        }
      });

      document.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        if (target.closest("[data-theme-toggle]")) {
          setTimeout(() => {
            applyChartTheme(habitChart);
          }, 0);
        }
      });
    });
  </script>
{% endblock %}
