{% extends "layout.html" %}
{% set title = "Goals" %}
{% set active_page = "goals" %}

{% block content %}
  <div class="container py-4 goals-page">
    <header class="header goals-header-bar">
      <div>
        <h1>Goals</h1>
        <p>Define outcomes, link projects, and track progress.</p>
      </div>
      <a class="btn btn-primary btn-sm" href="{{ url_for('new_goal') }}">
        <i class="bi bi-plus-lg"></i>
        Create New Goals
      </a>
    </header>

    <section class="goals-hero">
      <div class="goals-hero-left">
        <div class="goal-stat-card">
          <span class="goal-stat-label">Active goals</span>
          <span class="goal-stat-value">{{ active_goals_count or 0 }}</span>
          <span class="goal-stat-meta">Total goals: {{ goals | length }}</span>
        </div>
        <div class="goal-stat-card">
          <span class="goal-stat-label">Focus this week</span>
          <span class="goal-stat-value">{{ total_goal_seconds | format_seconds }}</span>
          <span class="goal-stat-meta">Across all goals</span>
        </div>
        <div class="goal-stat-card">
          <span class="goal-stat-label">Upcoming deadlines</span>
          <span class="goal-stat-value">{{ targets_set or 0 }}</span>
          <span class="goal-stat-meta">Targets set</span>
        </div>
      </div>
    </section>

    <section class="card goals-card">
      <div class="goals-header">
        <div>
          <p class="goals-label">Pipeline</p>
          <h2 class="goals-title">Goals in progress</h2>
        </div>
        <div class="goals-actions">
          <button class="btn btn-outline-secondary btn-sm" type="button">
            <i class="bi bi-funnel"></i>
            Filter
          </button>
          <button class="btn btn-outline-secondary btn-sm" type="button">
            <i class="bi bi-sort-down"></i>
            Sort
          </button>
          <a class="btn btn-primary btn-sm" href="{{ url_for('new_goal') }}">
            <i class="bi bi-plus-lg"></i>
            New Goal
          </a>
        </div>
      </div>

      <div class="goals-toolbar">
        <div class="goals-filters">
          <button class="btn btn-light btn-sm is-active" type="button">All</button>
          <button class="btn btn-light btn-sm" type="button">On track</button>
          <button class="btn btn-light btn-sm" type="button">At risk</button>
          <button class="btn btn-light btn-sm" type="button">Completed</button>
        </div>
        <div class="goals-search">
          <input type="text" placeholder="Search goals, projects, or tasks..." />
        </div>
      </div>

      <div class="goals-grid">
        {% if goals %}
          {% for goal in goals %}
            <article class="goal-card is-clickable" data-href="{{ url_for('goal_detail', goal_id=goal['id']) }}">
              <div class="goal-top">
                <span class="goal-status {{ 'paused' if goal['display_status'] == 'at_risk' else 'completed' if goal['display_status'] in ['completed', 'archived'] else 'active' }}">
                  {{ goal['display_status'] | replace('_', ' ') }}
                </span>
                <div class="goal-deadline">
                  <div class="deadline-ring" style="--progress: {{ goal['progress'] }};" title="Progress {{ goal['progress'] }}%">
                    <span>{{ goal['progress'] }}%</span>
                  </div>
                  {% if goal['target_date'] %}
                    <span class="deadline-date">Target {{ goal['target_date'] }}</span>
                  {% endif %}
                </div>
              </div>
              <div class="goal-card-header">
                <h3 class="goal-name">{{ goal['name'] }}</h3>
                <button class="edit-toggle icon-button" type="button" aria-label="Edit goal" data-edit-target="edit-goal-{{ goal['id'] }}">
                  <i class="bi bi-pencil"></i>
                </button>
              </div>
              {% if goal['description'] %}
                <p class="goal-desc">{{ goal['description'] }}</p>
              {% endif %}
              {% if goal['subgoals'] %}
                <ul class="goal-subgoals">
                  {% for subgoal in goal['subgoals'][:3] %}
                    <li>{{ subgoal['title'] }}</li>
                  {% endfor %}
                  {% if goal['subgoals_count'] > 3 %}
                    <li class="goal-subgoals-more">+{{ goal['subgoals_count'] - 3 }} more</li>
                  {% endif %}
                </ul>
              {% endif %}
              <div class="goal-progress">
                <div class="goal-progress-bar">
                  <span style="width: {{ goal['progress'] }}%"></span>
                </div>
                {% if goal['subgoals_count'] %}
                  <span class="goal-progress-text">{{ goal['subgoals_completed'] }} / {{ goal['subgoals_count'] }} sub-goals</span>
                {% else %}
                  <span class="goal-progress-text">{{ goal['progress'] }}% complete</span>
                {% endif %}
              </div>
              <form id="edit-goal-{{ goal['id'] }}" class="edit-form goal-edit-form" method="post" action="{{ url_for('edit_goal', goal_id=goal['id']) }}">
                <div class="goal-form-row">
                  <label>
                    Name
                    <input type="text" name="name" value="{{ goal['name'] }}" required />
                  </label>
                  <label>
                    Target date
                    <input type="date" name="target_date" value="{{ goal['target_date'] or '' }}" />
                  </label>
                </div>
                <div class="goal-form-row">
                  <label>
                    Status
                    <select name="status">
                      <option value="active" {% if goal['status'] == 'active' %}selected{% endif %}>Active</option>
                      <option value="at_risk" {% if goal['status'] == 'at_risk' %}selected{% endif %}>At risk</option>
                      <option value="completed" {% if goal['status'] == 'completed' %}selected{% endif %}>Completed</option>
                      <option value="archived" {% if goal['status'] == 'archived' %}selected{% endif %}>Archived</option>
                    </select>
                  </label>
                  <label>
                    Priority
                    <select name="priority">
                      <option value="high" {% if goal['priority'] == 'high' %}selected{% endif %}>High</option>
                      <option value="medium" {% if goal['priority'] == 'medium' %}selected{% endif %}>Medium</option>
                      <option value="low" {% if goal['priority'] == 'low' %}selected{% endif %}>Low</option>
                    </select>
                  </label>
                </div>
                <div class="goal-form-row">
                  <label>
                    Target hours
                    <input type="number" name="target_hours" min="0" step="0.5" value="{{ (goal['target_seconds'] / 3600) if goal['target_seconds'] else '' }}" />
                  </label>
                  <label>
                    Link projects
                    <div class="goal-select">
                      <select name="project_ids">
                        <option value="">Select a project</option>
                        {% for project in projects %}
                          <option value="{{ project['id'] }}" {% if project['id'] in goal['project_ids'] %}selected{% endif %}>
                            {{ project['name'] }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  </label>
                </div>
                <label>
                  Link tasks
                  <div class="goal-select">
                    <select name="task_ids">
                      <option value="">Select a task</option>
                      {% for task in tasks %}
                        <option value="{{ task['id'] }}" {% if task['id'] in goal['task_ids'] %}selected{% endif %}>
                          {{ task['name'] }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>
                </label>
                <label>
                  Description
                  <textarea rows="2" name="description">{{ goal['description'] or '' }}</textarea>
                </label>
                <div class="goal-form-actions">
                  <button class="btn btn-outline-secondary btn-sm" type="submit">Save changes</button>
                </div>
              </form>
              <form class="goal-delete-form" method="post" action="{{ url_for('delete_goal', goal_id=goal['id']) }}">
                <button class="btn btn-outline-danger btn-sm" type="submit">Delete</button>
              </form>
            </article>
          {% endfor %}
        {% else %}
          <p class="empty">No goals yet.</p>
        {% endif %}
      </div>
    </section>

    <section class="card subgoals-card">
      <div class="goals-header">
        <div>
          <p class="goals-label">Breakdown</p>
          <h2 class="goals-title">Sub-goals</h2>
        </div>
      </div>
      <div class="subgoals-grid">
        {% if goals %}
          {% for goal in goals %}
            {% if goal['subgoals'] %}
              <article class="subgoal-group">
                <div class="subgoal-group-header">
                  <div>
                    <h3>{{ goal['name'] }}</h3>
                    <p class="subgoal-group-meta">{{ goal['subgoals_completed'] }} / {{ goal['subgoals_count'] }} completed</p>
                  </div>
                  <div class="subgoal-progress">
                    <div class="deadline-ring" style="--progress: {{ goal['progress'] }};" title="Progress {{ goal['progress'] }}%">
                      <span>{{ goal['progress'] }}%</span>
                    </div>
                    <span class="goal-status {{ 'paused' if goal['display_status'] == 'at_risk' else 'completed' if goal['display_status'] in ['completed', 'archived'] else 'active' }}">
                      {{ goal['display_status'] | replace('_', ' ') }}
                    </span>
                  </div>
                </div>
                <div class="subgoal-list">
                  <form class="subgoal-add-form" method="post" action="{{ url_for('add_goal_subgoal', goal_id=goal['id']) }}">
                    <input type="text" name="title" placeholder="Add a sub-goal" required />
                    <input type="text" name="label" placeholder="Label" />
                    <input type="date" name="target_date" />
                    <select name="project_id">
                      <option value="">Project</option>
                      {% for project in projects %}
                        <option value="{{ project['id'] }}">{{ project['name'] }}</option>
                      {% endfor %}
                    </select>
                    <button class="btn btn-primary btn-sm" type="submit">
                      <i class="bi bi-plus-lg"></i>
                      Add
                    </button>
                  </form>
                  {% for subgoal in goal['subgoals'] %}
                    <div class="subgoal-item {% if subgoal['status'] == 'completed' %}is-done{% endif %}">
                      <form class="subgoal-toggle" method="post" action="{{ url_for('toggle_goal_subgoal', subgoal_id=subgoal['id']) }}">
                        <label>
                          <input type="checkbox" name="done" {% if subgoal['status'] == 'completed' %}checked{% endif %} onchange="this.form.submit()" />
                          <span class="subgoal-title">{{ subgoal['title'] }}</span>
                        </label>
                      </form>
                      <div class="subgoal-meta">
                        {% if subgoal['label'] %}
                          <span class="subgoal-tag">{{ subgoal['label'] }}</span>
                        {% endif %}
                        {% if subgoal['target_date'] %}
                          <span class="subgoal-date">{{ subgoal['target_date'] }}</span>
                        {% endif %}
                        {% if subgoal['project_name'] %}
                          <span class="subgoal-project">{{ subgoal['project_name'] }}</span>
                        {% endif %}
                        <span>{{ subgoal['created_at'][:10] }}</span>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </article>
            {% endif %}
          {% endfor %}
        {% else %}
          <p class="empty">No sub-goals yet.</p>
        {% endif %}
      </div>
    </section>

    <section class="card">
      <h2>Goal details</h2>
      <div class="goal-details-grid">
        <div class="goal-detail-card">
          <h3>Milestones</h3>
          <ul class="goal-detail-list">
            <li>Complete module 1 and 2</li>
            <li>Finish lab exercises</li>
            <li>Review practice exams</li>
          </ul>
        </div>
        <div class="goal-detail-card">
          <h3>Linked projects</h3>
          <ul class="goal-detail-list">
            <li>AWS Cloud Technical Essential</li>
            <li>Lab5</li>
            <li>Exam prep</li>
          </ul>
        </div>
        <div class="goal-detail-card">
          <h3>Next actions</h3>
          <ul class="goal-detail-list">
            <li>Schedule 2 focused sessions</li>
            <li>Review notes from last week</li>
            <li>Assign tasks to project</li>
          </ul>
        </div>
      </div>
    </section>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      document.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        const card = target.closest(".goal-card.is-clickable");
        if (card && !target.closest("a, button, input, select, textarea, label, form, .edit-form")) {
          const href = card.dataset.href;
          if (href) {
            window.location.href = href;
            return;
          }
        }
        const editButton = target.closest("[data-edit-target]");
        if (editButton) {
          event.preventDefault();
          const targetId = editButton.dataset.editTarget;
          const form = document.getElementById(targetId);
          if (!form) {
            return;
          }
          const isOpen = form.classList.contains("is-open");
          document.querySelectorAll(".edit-form.is-open").forEach((openForm) => {
            if (openForm !== form) {
              openForm.classList.remove("is-open");
            }
          });
          form.classList.toggle("is-open", !isOpen);
          if (!isOpen) {
            const input = form.querySelector('input[type="text"]');
            if (input) {
              input.focus();
              input.select();
            }
          }
          return;
        }
        if (!target.closest(".edit-form")) {
          document.querySelectorAll(".edit-form.is-open").forEach((openForm) => {
            openForm.classList.remove("is-open");
          });
        }
      });

      document.addEventListener("keydown", (event) => {
        if (event.key !== "Escape") {
          return;
        }
        document.querySelectorAll(".edit-form.is-open").forEach((openForm) => {
          openForm.classList.remove("is-open");
        });
      });
    });
  </script>
{% endblock %}
