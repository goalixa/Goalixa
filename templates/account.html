{% extends "layout.html" %}
{% set title = "Account" %}
{% set active_page = "account" %}

{% block content %}
  <main class="container py-4">
    <section class="card profile-card-lg">
      <div class="profile-card-lg-head">
        <div class="profile-avatar lg" aria-hidden="true">
          {{ (user.email or 'U')[:1].upper() }}
        </div>
        <div class="profile-main">
          <div class="profile-name-row">
            <h2>{{ profile.full_name|default(user.email.split('@')[0], true) }}</h2>
            <span class="profile-badge">Member</span>
          </div>
          <p class="profile-email">{{ user.email }}</p>
          {% if profile.bio|default('') %}
            <p class="profile-bio">{{ profile.bio }}</p>
          {% endif %}
          <div class="profile-meta-grid">
            <div>
              <p class="meta-label">User ID</p>
              <p class="meta-value">{{ profile.user_id|default(user.id, true) }}</p>
            </div>
            <div>
              <p class="meta-label">Phone</p>
              <p class="meta-value">{{ profile.phone|default('Not set', true) }}</p>
            </div>
            <div>
              <p class="meta-label">Timezone</p>
              <p class="meta-value">{{ timezone_name }}</p>
            </div>
          </div>
        </div>
        <div class="profile-actions-vertical">
          <a class="btn btn-outline-primary btn-sm" href="{{ url_for_security('change_password') }}">
            <i class="bi bi-shield-lock"></i>
            Change password
          </a>
          <a class="btn btn-primary btn-sm" href="{{ url_for_security('logout') }}">
            <i class="bi bi-box-arrow-right"></i>
            Log out
          </a>
        </div>
      </div>
      <form class="profile-form" method="post" action="{{ url_for('update_profile') }}" id="profile-form">
        <div class="profile-form-actions top">
          <button class="btn btn-outline-secondary btn-sm" type="button" id="profile-edit">
            <i class="bi bi-pencil"></i>
            Edit profile
          </button>
          <button class="btn btn-primary btn-sm is-hidden" type="submit" id="profile-save">
            <i class="bi bi-check2-circle"></i>
            Save changes
          </button>
        </div>
        <div class="goal-form-row habit-form-row">
          <label class="habit-field-card">
            Full name
            <input
              type="text"
              name="full_name"
              value="{{ profile.full_name|default('', true) }}"
              placeholder="e.g. Sara Ahmadi"
              autocomplete="name"
              minlength="2"
              maxlength="80"
              disabled
            />
            <span class="profile-hint">Use your real name so teammates recognize you.</span>
          </label>
          <label class="habit-field-card">
            Phone
            <input
              type="tel"
              name="phone"
              value="{{ profile.phone|default('', true) }}"
              placeholder="+1 555 123 4567"
              inputmode="tel"
              pattern="^[+0-9\\s().-]{7,20}$"
              title="Enter digits, spaces, +, -, ()"
              disabled
            />
            <span class="profile-hint">Include country code for notification SMS or calls.</span>
          </label>
        </div>
        <label class="habit-field-card">
          Bio
          <textarea
            name="bio"
            rows="3"
            placeholder="Short bio or role"
            maxlength="160"
            disabled
          >{{ profile.bio|default('', true) }}</textarea>
          <span class="profile-hint">Max 160 characters. Share your role, focus area, or motto.</span>
        </label>
      </form>
    </section>

    <section class="card">
      <h2>App settings</h2>
      <form method="post" action="{{ url_for('update_timezone') }}">
        <label class="d-block mb-2">
          Timezone
          <select class="form-select mt-2" name="timezone">
            {% for tz in timezone_options %}
              <option value="{{ tz }}" {% if tz == timezone_name %}selected{% endif %}>{{ tz }}</option>
            {% endfor %}
          </select>
        </label>
        <button class="btn btn-outline-primary btn-sm" type="submit">
          <i class="bi bi-check2-circle"></i>
          Save settings
        </button>
      </form>
    </section>

    <section class="card">
      <h2>Notification settings</h2>
      <form method="post" action="{{ url_for('update_notifications') }}">
        <div class="form-check form-switch mb-3">
          <input
            class="form-check-input"
            type="checkbox"
            name="notifications_enabled"
            id="notifications-enabled"
            {% if notification_settings.enabled %}checked{% endif %}
          />
          <label class="form-check-label" for="notifications-enabled">
            Remind me to track focus when Pomodoro is off
          </label>
        </div>
        <label class="d-block mb-3">
          Reminder interval (minutes)
          <select class="form-select mt-2" name="notifications_interval_minutes">
            {% for minutes in [1, 5, 10, 15, 20] %}
              <option value="{{ minutes }}" {% if minutes == notification_settings.interval_minutes %}selected{% endif %}>
                {{ minutes }} minute{% if minutes != 1 %}s{% endif %}
              </option>
            {% endfor %}
          </select>
        </label>
        <div class="d-flex gap-3 flex-wrap mb-3">
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              name="notifications_show_toast"
              id="notifications-show-toast"
              {% if notification_settings.show_toast %}checked{% endif %}
            />
            <label class="form-check-label" for="notifications-show-toast">
              Show in-page popup
            </label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              name="notifications_show_system"
              id="notifications-show-system"
              {% if notification_settings.show_system %}checked{% endif %}
            />
            <label class="form-check-label" for="notifications-show-system">
              Send system notification
            </label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="checkbox"
              name="notifications_play_sound"
              id="notifications-play-sound"
              {% if notification_settings.play_sound %}checked{% endif %}
            />
            <label class="form-check-label" for="notifications-play-sound">
              Play sound
            </label>
          </div>
        </div>
        <label class="d-block mb-3">
          Popup title
          <input
            class="form-control mt-2"
            type="text"
            name="notifications_title"
            value="{{ notification_settings.title }}"
          />
        </label>
        <label class="d-block mb-3">
          Popup message
          <textarea
            class="form-control mt-2"
            name="notifications_message"
            rows="3"
          >{{ notification_settings.message }}</textarea>
        </label>
        <div class="d-flex gap-2 flex-wrap">
          <button class="btn btn-outline-primary btn-sm" type="submit">
            <i class="bi bi-check2-circle"></i>
            Save notification settings
          </button>
          <button class="btn btn-outline-secondary btn-sm" type="button" id="notifications-test">
            <i class="bi bi-bell"></i>
            Test notification
          </button>
        </div>
      </form>
    </section>
  </main>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (() => {
      const form = document.getElementById("profile-form");
      if (!form) return;
      const editBtn = document.getElementById("profile-edit");
      const saveBtn = document.getElementById("profile-save");
      const fields = form.querySelectorAll("input, textarea");
      const setEditable = (editable) => {
        fields.forEach((field) => {
          field.disabled = !editable;
        });
        if (saveBtn) saveBtn.classList.toggle("is-hidden", !editable);
        if (editBtn) editBtn.classList.toggle("is-hidden", editable);
        if (editable && fields.length) {
          fields[0].focus();
          fields[0].select();
        }
      };
      editBtn?.addEventListener("click", () => setEditable(true));
      form.addEventListener("submit", () => setEditable(false));
    })();
  </script>
{% endblock %}
