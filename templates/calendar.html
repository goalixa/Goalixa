{% extends "layout.html" %}
{% set title = "Calendar" %}
{% set active_page = "calendar" %}

{% block head_extra %}
  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fullcalendar/fullcalendar.min.css') }}" />
{% endblock %}

{% block content %}
  <main class="calendar-page">
    <section class="container py-4">
      <div class="card calendar-card">
        <div id="calendar-page"></div>
      </div>
    </section>
  </main>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='vendor/fullcalendar/fullcalendar.min.js') }}"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const calendarEl = document.getElementById("calendar-page");
      if (!calendarEl || typeof FullCalendar === "undefined") {
        return;
      }
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        height: "auto",
        headerToolbar: {
          left: "prev,next today",
          center: "title",
          right: "dayGridMonth,dayGridWeek,dayGridDay",
        },
        dayMaxEvents: 4,
        dayMaxEventRows: 4,
        eventDisplay: "block",
        dateClick: (info) => {
          calendar.changeView("dayGridDay", info.dateStr);
        },
        events: (info, success, failure) => {
          const params = new URLSearchParams({
            start: info.startStr,
            end: info.endStr,
          });
          fetch(`/api/timer/entries?${params.toString()}`)
            .then((response) => response.json())
            .then((payload) => success(payload.events || []))
            .catch((error) => {
              console.error(error);
              failure(error);
            });
        },
      });
      calendar.render();
    });
  </script>
{% endblock %}
