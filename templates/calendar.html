{% extends "layout.html" %}
{% set title = "Calendar" %}
{% set active_page = "calendar" %}

{% block content %}
  <div class="container py-4 calendar-page">
    <header class="header calendar-header">
      <div class="calendar-title-wrap">
        <h1>Calendar</h1>
      </div>
    </header>

    <div class="calendar-toolbar">
      <div class="calendar-filters">
        <div class="calendar-toggle">
          <button class="btn btn-outline-primary btn-sm is-active" type="button" data-calendar-toggle="tasks">
            Task 
          </button>
          <button class="btn btn-outline-primary btn-sm" type="button" data-calendar-toggle="habits">
            Habit
          </button>
        </div>
        <div class="calendar-filter" data-calendar-filter>
          <label for="calendar-project-filter">Project</label>
          <select id="calendar-project-filter" {% if not projects %}disabled{% endif %}>
            <option value="">All projects</option>
            {% for project in projects %}
              <option value="{{ project['id'] }}">{{ project['name'] }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="calendar-week-meta">
      </div>
    </div>

    <section class="card calendar-week-board" data-tour-id="calendar-board">
      <div class="calendar-week-grid calendar-week-header-row" data-calendar-section="tasks">
        <div class="calendar-weekday calendar-task-header">Tasks</div>
        {% for day in week_days %}
          <div class="calendar-weekday{% if day.is_today %} is-today{% endif %}">
            <span class="calendar-weekday-name">{{ day.day }}</span>
            <span class="calendar-weekday-date">{{ day.date }}</span>
          </div>
        {% endfor %}
      </div>

      {% if task_rows %}
        <div class="calendar-week-body" data-calendar-section="tasks">
          {% for task in task_rows %}
            <div
              class="calendar-week-grid calendar-week-row"
              data-calendar-row
              data-project-id="{{ task['project_id'] or '' }}"
            >
              <div class="calendar-task-cell">
                <span class="calendar-task-name">{{ task["name"] }}</span>
                <span class="calendar-task-meta">
                  {% if task["project_name"] %}{{ task["project_name"] }}{% else %}No project{% endif %}
                </span>
              </div>
              {% for day in week_days %}
                {% set checked = task.week_checks[loop.index0] %}
                <div class="calendar-day-cell{% if day.is_today %} is-today{% endif %}">
                  <span
                    class="calendar-check{% if checked %} is-checked{% elif day.is_future %}{% else %} is-missed{% endif %}"
                    title="{{ day.full }}"
                  ></span>
                </div>
              {% endfor %}
            </div>
          {% endfor %}
        </div>
        <p class="empty" id="calendar-empty-filter" hidden>No tasks match this view.</p>
      {% else %}
        <p class="empty" data-calendar-section="tasks">No tasks yet.</p>
      {% endif %}

      <div class="calendar-week-grid calendar-week-header-row" data-calendar-section="habits">
        <div class="calendar-weekday calendar-task-header">Habits</div>
        {% for day in week_days %}
          <div class="calendar-weekday{% if day.is_today %} is-today{% endif %}">
            <span class="calendar-weekday-name">{{ day.day }}</span>
            <span class="calendar-weekday-date">{{ day.date }}</span>
          </div>
        {% endfor %}
      </div>

      {% if habit_rows %}
        <div class="calendar-week-body" data-calendar-section="habits">
          {% for habit in habit_rows %}
            <div class="calendar-week-grid calendar-week-row">
              <div class="calendar-task-cell">
                <span class="calendar-task-name">{{ habit["name"] }}</span>
                <span class="calendar-task-meta">{{ habit["frequency"] }}</span>
              </div>
              {% for day in week_days %}
                {% set checked = habit.week_checks[loop.index0] %}
                <div class="calendar-day-cell{% if day.is_today %} is-today{% endif %}">
                  <span
                    class="calendar-check{% if checked %} is-checked{% elif day.is_future %}{% else %} is-missed{% endif %}"
                    title="{{ day.full }}"
                  ></span>
                </div>
              {% endfor %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="empty" data-calendar-section="habits">No habits yet.</p>
      {% endif %}
    </section>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (() => {
      const rows = document.querySelectorAll("[data-calendar-row]");
      const projectFilter = document.getElementById("calendar-project-filter");
      const emptyState = document.getElementById("calendar-empty-filter");
      const toggleButtons = document.querySelectorAll("[data-calendar-toggle]");
      const sections = document.querySelectorAll("[data-calendar-section]");
      const projectFilterWrap = document.querySelector("[data-calendar-filter]");

      const applyFilter = () => {
        if (!rows.length || !projectFilter) return;
        const selected = projectFilter.value;
        let visibleCount = 0;
        rows.forEach((row) => {
          let isVisible = true;
          if (selected) {
            const projectId = row.dataset.projectId || "";
            isVisible = projectId === selected;
          }
          row.hidden = !isVisible;
          if (isVisible) {
            visibleCount += 1;
          }
        });

        if (emptyState) {
          emptyState.hidden = visibleCount !== 0;
        }
      };

      const setActiveSection = (target) => {
        sections.forEach((section) => {
          const show = section.dataset.calendarSection === target;
          section.hidden = !show;
        });
        toggleButtons.forEach((button) => {
          button.classList.toggle("is-active", button.dataset.calendarToggle === target);
        });
        const showTasks = target === "tasks";
        if (projectFilterWrap) {
          projectFilterWrap.hidden = !showTasks;
        }
        if (projectFilter) {
          projectFilter.disabled = !showTasks;
        }
        if (!showTasks && emptyState) {
          emptyState.hidden = true;
        }
      };

      if (projectFilter) {
        projectFilter.addEventListener("change", applyFilter);
        applyFilter();
      }

      toggleButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const target = button.dataset.calendarToggle;
          setActiveSection(target);
        });
      });

      setActiveSection("tasks");
    })();
  </script>
{% endblock %}
