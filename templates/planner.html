{% extends "layout.html" %}
{% set title = "Planner" %}
{% set active_page = "planner" %}

{% block content %}
  <div class="container py-4 planner-page">
    <header class="header planner-header">
      <div>
        <h1>Daily Planner</h1>
        <p>Habits and a to-do list in one focused view.</p>
      </div>
      <div class="planner-header-actions">
        <div class="planner-toggle" role="group" aria-label="Planner view toggle">
          <button class="planner-toggle-btn is-active" type="button" data-planner-panel="habits" aria-pressed="true">Habits</button>
          <button class="planner-toggle-btn" type="button" data-planner-panel="todos" aria-pressed="false">To-dos</button>
        </div>
      </div>
    </header>

    <section class="planner-hero">
      <div class="planner-stat-card">
        <span class="planner-stat-label">Habits done</span>
        <span class="planner-stat-value">{{ habits_summary["completed"] or 0 }}</span>
        <span class="planner-stat-meta">Out of {{ habits_summary["total"] or 0 }}</span>
      </div>
      <div class="planner-stat-card">
        <span class="planner-stat-label">To-do items</span>
        <span class="planner-stat-value">{{ todos | length }}</span>
        <span class="planner-stat-meta">{{ done_todos | length }} done today</span>
      </div>
      <div class="planner-stat-card">
        <span class="planner-stat-label">Best habit streak</span>
        <span class="planner-stat-value">{{ habits_summary["best_streak"] or 0 }} days</span>
        <span class="planner-stat-meta">Keep the chain strong</span>
      </div>
    </section>

    <section class="planner-grid">
      <article class="card planner-card is-active" data-planner-section="habits">
        <div class="planner-card-header">
          <div>
            <p class="goals-label">Habits</p>
            <h2 class="goals-title">Always-on routines</h2>
          </div>
          <span class="planner-panel-meta">{{ habits_summary["completed"] or 0 }} / {{ habits_summary["total"] or 0 }}</span>
        </div>
        <form class="planner-form" method="post" action="{{ url_for('create_habit') }}">
          <input type="hidden" name="next" value="{{ url_for('planner') }}" />
          <input type="text" name="name" placeholder="New habit" required />
          <select name="frequency">
            <option value="Daily">Daily</option>
            <option value="Weekdays">Weekdays</option>
            <option value="Weekends">Weekends</option>
          </select>
          <select name="time_of_day">
            <option value="">Anytime</option>
            <option value="Morning">Morning</option>
            <option value="Afternoon">Afternoon</option>
            <option value="Evening">Evening</option>
          </select>
          <button class="btn btn-primary btn-sm" type="submit">
            <i class="bi bi-plus-lg"></i>
            Add habit
          </button>
        </form>
        <div class="habit-list planner-habit-list">
          {% if habits %}
            {% for habit in habits %}
              <div class="habit-row {% if habit['done'] %}is-done{% endif %}">
                <form class="habit-toggle" method="post" action="{{ url_for('toggle_habit', habit_id=habit['id']) }}">
                  <input type="hidden" name="next" value="{{ url_for('planner') }}" />
                  <input type="hidden" name="date" value="{{ today }}" />
                  <label class="habit-left">
                    <span class="habit-checkbox">
                      <input type="checkbox" name="done" {% if habit['done'] %}checked{% endif %} onchange="this.form.submit()" />
                      <span class="habit-checkmark"></span>
                    </span>
                    <span class="habit-text">
                      <span class="habit-name">{{ habit['name'] }}</span>
                      <span class="habit-meta">{{ habit['meta'] }}</span>
                    </span>
                  </label>
                </form>
                <span class="planner-badge">
                  <i class="bi bi-fire"></i>
                  {{ habit['streak'] }}d
                </span>
              </div>
            {% endfor %}
          {% else %}
            <p class="empty">No habits yet. Add one to build your rhythm.</p>
          {% endif %}
        </div>
      </article>

      <article class="card planner-card" data-planner-section="todos">
        <div class="planner-card-header">
          <div>
            <p class="goals-label">To-do</p>
            <h2 class="goals-title">Daily execution list</h2>
          </div>
          <span class="planner-panel-meta">{{ done_todos | length }} done today</span>
        </div>
        <form class="task-form planner-task-form" method="post" action="{{ url_for('create_todo') }}">
          <input type="text" name="name" placeholder="New to-do" required />
          <button class="btn btn-primary btn-sm" type="submit">
            <i class="bi bi-plus-lg"></i>
            Add
          </button>
        </form>

        <div class="planner-todo">
          <h4>To do now</h4>
          {% if todos %}
            <ul class="planner-task-list">
              {% for todo in todos %}
                <li class="planner-task-item">
                  <div class="planner-task-info">
                    <span class="planner-task-title">{{ todo['name'] }}</span>
                    <span class="planner-task-meta">Today</span>
                  </div>
                  <div class="planner-task-actions">
                    <form method="post" action="{{ url_for('toggle_todo', todo_id=todo['id']) }}">
                      <input type="hidden" name="done" value="1" />
                      <button class="btn btn-outline-success btn-sm" type="submit" aria-label="Mark done">
                        <i class="bi bi-check2-circle"></i>
                      </button>
                    </form>
                    <form method="post" action="{{ url_for('delete_todo', todo_id=todo['id']) }}">
                      <button class="btn btn-outline-danger btn-sm" type="submit" aria-label="Delete to-do">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="empty">All clear. Add a to-do or plan tomorrow.</p>
          {% endif %}
        </div>

        <div class="planner-todo planner-todo-done">
          <h4>Done today</h4>
          {% if done_todos %}
            <ul class="planner-task-list">
              {% for todo in done_todos %}
                <li class="planner-task-item is-done">
                  <div class="planner-task-info">
                    <span class="planner-task-title">{{ todo['name'] }}</span>
                    <span class="planner-task-meta">Done</span>
                  </div>
                  <div class="planner-task-actions">
                    <form method="post" action="{{ url_for('toggle_todo', todo_id=todo['id']) }}">
                      <input type="hidden" name="done" value="0" />
                      <button class="btn btn-outline-secondary btn-sm" type="submit">
                        <i class="bi bi-arrow-counterclockwise"></i>
                        Reopen
                      </button>
                    </form>
                    <form method="post" action="{{ url_for('delete_todo', todo_id=todo['id']) }}">
                      <button class="btn btn-outline-danger btn-sm" type="submit" aria-label="Delete to-do">
                        <i class="bi bi-trash"></i>
                      </button>
                    </form>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="empty">Nothing checked off yet.</p>
          {% endif %}
        </div>
      </article>
    </section>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    (() => {
      const page = document.querySelector(".planner-page");
      if (!page) return;

      const activate = (target) => {
        const toggleButtons = page.querySelectorAll("[data-planner-panel]");
        const panels = page.querySelectorAll("[data-planner-section]");
        toggleButtons.forEach((btn) => {
          const isActive = btn.dataset.plannerPanel === target;
          btn.classList.toggle("is-active", isActive);
          btn.setAttribute("aria-pressed", String(isActive));
        });
        panels.forEach((panel) => {
          panel.classList.toggle("is-active", panel.dataset.plannerSection === target);
        });
      };

      const updatePlannerContentFromDocument = (nextDoc) => {
        const activeButton = page.querySelector("[data-planner-panel].is-active");
        const activePanel = activeButton?.dataset?.plannerPanel || "habits";

        const nextHero = nextDoc.querySelector(".planner-hero");
        const nextGrid = nextDoc.querySelector(".planner-grid");
        const currentHero = page.querySelector(".planner-hero");
        const currentGrid = page.querySelector(".planner-grid");
        if (!nextHero || !nextGrid || !currentHero || !currentGrid) {
          throw new Error("Planner content not found");
        }

        currentHero.replaceWith(nextHero);
        currentGrid.replaceWith(nextGrid);
        activate(activePanel);
      };

      const updatePlannerContentFromHtml = (html) => {
        const nextDoc = new DOMParser().parseFromString(html, "text/html");
        updatePlannerContentFromDocument(nextDoc);
      };

      page.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        const button = target.closest("[data-planner-panel]");
        if (!button) {
          return;
        }
        activate(button.dataset.plannerPanel);
      });

      let isSubmitting = false;
      page.addEventListener("submit", async (event) => {
        const form = event.target;
        if (!(form instanceof HTMLFormElement)) {
          return;
        }
        if ((form.method || "").toUpperCase() !== "POST") {
          return;
        }

        event.preventDefault();
        if (isSubmitting) {
          return;
        }

        if (form.action.includes("/todos/") && form.action.includes("/delete")) {
          if (!window.confirm("Delete this to-do?")) {
            return;
          }
        }

        isSubmitting = true;
        const submitter = event.submitter;
        if (submitter instanceof HTMLButtonElement) {
          submitter.disabled = true;
        }

        try {
          const response = await fetch(form.action, {
            method: "POST",
            body: new FormData(form),
            headers: { "X-Requested-With": "XMLHttpRequest" },
          });
          if (!response.ok) {
            throw new Error("Planner action failed");
          }
          const html = await response.text();
          updatePlannerContentFromHtml(html);
        } catch (error) {
          HTMLFormElement.prototype.submit.call(form);
        } finally {
          isSubmitting = false;
          if (submitter instanceof HTMLButtonElement) {
            submitter.disabled = false;
          }
        }
      });
    })();
  </script>
{% endblock %}
